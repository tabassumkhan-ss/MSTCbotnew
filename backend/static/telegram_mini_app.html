<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MSTC Earning Project — Deposit & Reward System</title>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #050816;
      color: #f8fafc;
    }
    #app {
      max-width: 480px;
      margin: 0 auto;
      padding: 16px;
    }
    .card {
      background: rgba(15, 23, 42, 0.9);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: 0 10px 30px rgba(15, 23, 42, 0.7);
    }
    h1, h2, h3 {
      margin: 0 0 8px;
    }
    .btn {
      display: inline-block;
      padding: 10px 16px;
      border-radius: 999px;
      border: none;
      outline: none;
      cursor: pointer;
      font-weight: 600;
      margin-top: 8px;
      font-size: 14px;
    }
    .btn-primary {
      background: #0f766e;
      color: white;
    }
    .btn-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .btn-secondary {
      background: #1e293b;
      color: #e5e7eb;
    }
    .field {
      margin-bottom: 12px;
    }
    .field label {
      display: block;
      font-size: 13px;
      margin-bottom: 4px;
      color: #9ca3af;
    }
    .field input {
      width: 100%;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid #1f2937;
      background: #020617;
      color: #e5e7eb;
      font-size: 14px;
    }
    .field input:focus {
      outline: none;
      border-color: #0f766e;
    }
    .status {
      font-size: 13px;
      color: #9ca3af;
      margin-top: 8px;
      white-space: pre-line;
    }
    .error {
      color: #fecaca;
    }
    .success {
      color: #bbf7d0;
    }
    .muted {
      font-size: 12px;
      color: #6b7280;
    }
  </style>
</head>
<body>
  <div id="app">
    <div class="card">
      <h2>MSTC Deposit Mini App</h2>
      <p class="muted" id="welcomeText">Loading Telegram data…</p>
      <p class="muted" id="refInfo"></p>
    </div>

    <div class="card" id="registerCard" style="display:none;">
      <h3>Register & Join Team</h3>
      <p class="muted">
        Tap below to register your account in MSTC system.
      </p>
      <button class="btn btn-primary" id="registerBtn">Register Now</button>
      <div class="status" id="registerStatus"></div>
    </div>

    <div class="card" id="walletCard" style="display:none;">
      <h3>Your TON Wallet</h3>
      <div class="field">
        <label for="walletInput">Wallet address</label>
        <input id="walletInput" placeholder="Paste your TON wallet address" />
      </div>
      <button class="btn btn-secondary" id="saveWalletBtn">Save Wallet</button>
      <div class="status" id="walletStatus"></div>
    </div>

    <div class="card" id="depositCard" style="display:none;">
      <h3>Make a Deposit</h3>
      <div class="field">
        <label for="amountInput">Deposit amount (MSTC)</label>
        <input id="amountInput" type="number" step="0.01" min="0" placeholder="e.g. 20" />
      </div>
      <button class="btn btn-primary" id="verifyBtn">Submit Deposit</button>
      <div class="status" id="verifyStatus"></div>
    </div>

    <div class="card" id="userInfoCard" style="display:none;">
      <h3>Your Status</h3>
      <div class="status" id="userInfo"></div>
    </div>
  </div>

  <script>
    const tg = window.Telegram.WebApp || {};
    if (tg.expand) tg.expand();

    // ─────────────────────────────────────────────
    // REF HANDLING (THIS IS WHAT FIXES referrer_id)
    // ─────────────────────────────────────────────
    const urlParams = new URLSearchParams(window.location.search);
    const refFromUrl = urlParams.get("ref") || urlParams.get("startapp");
    const refFromInit = tg.initDataUnsafe && tg.initDataUnsafe.start_param;
    // This is what we will send to backend as "ref"
    const ref = refFromUrl || refFromInit || null;

    console.log("REF DEBUG:", { refFromUrl, refFromInit, ref });

    // ─────────────────────────────────────────────
    // DOM elements
    // ─────────────────────────────────────────────
    const registerCard   = document.getElementById("registerCard");
    const registerBtn    = document.getElementById("registerBtn");
    const registerStatus = document.getElementById("registerStatus");

    const walletCard   = document.getElementById("walletCard");
    const walletInput  = document.getElementById("walletInput");
    const walletStatus = document.getElementById("walletStatus");
    const saveWalletBtn = document.getElementById("saveWalletBtn");

    const depositCard   = document.getElementById("depositCard");
    const amountInput   = document.getElementById("amountInput");
    const verifyBtn     = document.getElementById("verifyBtn");
    const verifyStatus  = document.getElementById("verifyStatus");

    const welcomeText = document.getElementById("welcomeText");
    const refInfo     = document.getElementById("refInfo");
    const userInfoCard = document.getElementById("userInfoCard");
    const userInfo     = document.getElementById("userInfo");

    let currentUserId = null;
    let currentUsername = null;
    let currentFirstName = null;

    function showStatus(el, text, type) {
      el.textContent = text || "";
      el.classList.remove("error", "success");
      if (type === "error") el.classList.add("error");
      if (type === "success") el.classList.add("success");
    }

    // ─────────────────────────────────────────────
    // INIT APP: /webapp/init
    // ─────────────────────────────────────────────
    async function initApp() {
      try {
        const initData = tg.initData || "";
        const body = {
          initData,     // raw initData string
          // Not strictly needed by /webapp/init, but harmless to include:
          ref           // <── we pass ref so backend can use get_ref_from_payload if it wants
        };

        const res = await fetch("/webapp/init", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body),
        });

        const data = await res.json();
        console.log("INIT RESPONSE", data);

        if (!data.ok) {
          welcomeText.textContent = "Failed to initialize: " + (data.error || "unknown");
          return;
        }

        currentUserId = data.user_id;
        currentUsername = data.username;
        currentFirstName = data.first_name;

        welcomeText.textContent =
          `Hello ${currentFirstName || ""} (@${currentUsername || "user"})`;

        if (data.referrer_username || data.referrer_id) {
          refInfo.textContent =
            `You are joining via: ${data.referrer_username || ("ID " + data.referrer_id)}`;
        } else if (ref) {
          refInfo.textContent =
            `Referral code detected: ${ref}`;
        } else {
          refInfo.textContent = "No referrer detected.";
        }

        if (!data.exists) {
          // brand new user -> show register
          registerCard.style.display = "block";
          walletCard.style.display   = "none";
          depositCard.style.display  = "none";
          userInfoCard.style.display = "none";
        } else {
          // existing user
          registerCard.style.display = "none";
          walletCard.style.display   = "block";
          depositCard.style.display  = "block";
          userInfoCard.style.display = "block";

          userInfo.textContent =
            `Status: ${data.role}\n` +
            `Self activated: ${data.self_activated ? "Yes" : "No"}\n` +
            `Total team business: ${data.total_team_business}`;
        }

      } catch (err) {
        console.error("initApp error", err);
        welcomeText.textContent = "Server error during init.";
      }
    }

    // ─────────────────────────────────────────────
    // REGISTER: /webapp/register  (HERE WE SEND ref)
    // ─────────────────────────────────────────────
    registerBtn.addEventListener("click", async () => {
      registerBtn.disabled = true;
      showStatus(registerStatus, "Registering…");

      try {
        const initData = tg.initData || "";
        const body = {
          initData,
          ref,   // <── IMPORTANT: back-end will pick this up via get_ref_from_payload
        };

        const res = await fetch("/webapp/register", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body),
        });

        const data = await res.json();
        console.log("REGISTER RESPONSE", data);

        if (!data.ok) {
          showStatus(registerStatus, "Failed: " + (data.error || "unknown"), "error");
          registerBtn.disabled = false;
          return;
        }

        currentUserId = data.user_id;
        showStatus(registerStatus, "Registered successfully!", "success");

        // After register -> show wallet + deposit
        registerCard.style.display = "none";
        walletCard.style.display   = "block";
        depositCard.style.display  = "block";
        userInfoCard.style.display = "block";

        userInfo.textContent =
          `Status: ${data.role}\n` +
          `Self activated: ${data.is_active ? "Yes" : "No"}\n` +
          `Total team business: 0`;

      } catch (err) {
        console.error("register error", err);
        showStatus(registerStatus, "Server error during register.", "error");
      } finally {
        registerBtn.disabled = false;
      }
    });

    // ─────────────────────────────────────────────
    // SAVE WALLET: /webapp/save_wallet
    // ─────────────────────────────────────────────
    saveWalletBtn.addEventListener("click", async () => {
      const wallet_address = walletInput.value.trim();
      if (!wallet_address) {
        showStatus(walletStatus, "Please enter wallet address.", "error");
        return;
      }
      if (!currentUserId) {
        showStatus(walletStatus, "User not initialized.", "error");
        return;
      }

      saveWalletBtn.disabled = true;
      showStatus(walletStatus, "Saving wallet…");

      try {
        const res = await fetch("/webapp/save_wallet", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            telegram_id: currentUserId,
            wallet_address,
          }),
        });

        const data = await res.json();
        console.log("SAVE_WALLET RESPONSE", data);

        if (!data.ok) {
          showStatus(walletStatus, "Failed: " + (data.error || "unknown"), "error");
          return;
        }

        showStatus(walletStatus, "Wallet saved successfully.", "success");
      } catch (err) {
        console.error("save wallet error", err);
        showStatus(walletStatus, "Server error saving wallet.", "error");
      } finally {
        saveWalletBtn.disabled = false;
      }
    });

    // ─────────────────────────────────────────────
    // VERIFY / DEPOSIT: /webapp/verify  (HERE WE SEND ref)
    // ─────────────────────────────────────────────
    verifyBtn.addEventListener("click", async () => {
      const raw = amountInput.value.trim();
      const amount = parseFloat(raw || "0");
      if (!amount || amount <= 0) {
        showStatus(verifyStatus, "Enter a valid amount.", "error");
        return;
      }

      verifyBtn.disabled = true;
      showStatus(verifyStatus, "Submitting deposit…");

      try {
        const initData = tg.initData || "";
        const body = {
          initData,
          amount,
          ref,   // <── IMPORTANT: back-end uses this if user has no referrer yet
        };

        const res = await fetch("/webapp/verify", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body),
        });

        const data = await res.json();
        console.log("VERIFY RESPONSE", data);

        if (!data.ok) {
          showStatus(
            verifyStatus,
            "Failed: " + (data.message || data.error || "unknown"),
            "error"
          );
          return;
        }

        showStatus(
          verifyStatus,
          `Deposit processed. Amount: ${data.amount}. Role: ${data.role}.`,
          "success"
        );

        if (data.user_id) currentUserId = data.user_id;
      } catch (err) {
        console.error("verify error", err);
        showStatus(verifyStatus, "Server error during verify.", "error");
      } finally {
        verifyBtn.disabled = false;
      }
    });

    // ─────────────────────────────────────────────
    // Start
    // ─────────────────────────────────────────────
    window.addEventListener("load", initApp);
  </script>
</body>
</html>
