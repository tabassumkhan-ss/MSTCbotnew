<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MSTC Earning Project ‚Äî Deposit & Reward System</title>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>

  <style>

    #app {
  position: relative;
}
    * { box-sizing: border-box; }

    body {
      margin: 0;
      min-height: 100vh;
      display: block; /* content flows from top */
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
      text-align: center;
      color: #fff;
      background:
        radial-gradient(1200px 600px at 50% -20%, rgba(255,255,255,.08), transparent 60%),
        linear-gradient(135deg, #5c3cff, #0e1630 60%);
      overflow-y: auto;
      overflow-x: hidden;
      padding: 12px 10px 24px;
    }

    .card {
      width: min(720px, 96vw);
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.15);
      border-radius: 20px;
      padding: 22px;
      box-shadow: 0 18px 50px rgba(0,0,0,.25);
      backdrop-filter: blur(6px);
      margin: 8px auto 24px;
    }

    .logo {
      width: 88px;
      height: 88px;
      border-radius: 50%;
      object-fit: cover;
      border: 4px solid rgba(255,255,255,.35);
      margin: 0 auto 14px;
      display: block;
      box-shadow:
        0 10px 26px rgba(0,0,0,.35),
        0 0 0 8px rgba(255,255,255,.08) inset;
      position: relative;
    }

    .logo.glow {
      border-color: transparent;
      box-shadow: none;
      isolation:isolate;
    }

    .logo.glow::before,
    .logo.glow::after {
      content: "";
      position: absolute;
      inset: -6px;
      border-radius: 50%;
      z-index: -1;
    }

    .logo.glow::before {
      background: conic-gradient(
        from 0deg,
        #6cf 0%,
        #8af 25%,
        #9ff 50%,
        #7df 75%,
        #6cf 100%
      );
      filter: blur(6px);
      animation: spin 4s linear infinite;
      opacity: .95;
    }

    .logo.glow::after {
      inset: -14px;
      background: radial-gradient(
        closest-side,
        rgba(108,240,255,.5),
        rgba(0,0,0,0)
      );
      filter: blur(10px);
      opacity: .65;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    h2 {
      margin: 0 0 10px;
      font-weight: 700;
    }

    .row {
      margin: 10px 0;
      font-size: 1.05rem;
    }

    .big {
      font-size: 1.25rem;
      font-weight: 700;
    }

    .actions {
      margin-top: 16px;
      display: flex;
      gap: 12px;
      justify-content: center;
    }

    .btn {
      padding: 11px 22px;
      border-radius: 22px;
      border: 0;
      cursor: pointer;
      font-weight: 600;
      background: #00c853;
      color: #fff;
      box-shadow: 0 8px 24px rgba(0,200,83,.35);
    }

    .btn.alt {
      background: #e53935;
      box-shadow: 0 8px 24px rgba(229,57,53,.35);
    }

    .ref-line {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      margin-top: 8px;
    }

    .copy-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 36px;
      height: 36px;
      border-radius: 10px;
      border: none;
      cursor: pointer;
      background: rgba(255,255,255,.16);
      color: #fff;
      font-size: 18px;
      transition: transform .12s ease, opacity .2s;
    }

    .copy-btn:active {
      transform: scale(.96);
    }

    .tooltip {
      margin-top: 8px;
      font-size: .85rem;
      opacity: 0;
      transition: opacity .25s;
    }

    .show {
      opacity: 1;
    }

    .panel {
      margin-top: 18px;
      text-align: left;
      background: rgba(0,0,0,.18);
      padding: 16px;
      border-radius: 14px;
    }

    .panel h3 {
      margin: 0 0 10px;
      color: #fff;
    }

    label {
      display: block;
      font-size: .95rem;
      opacity: .9;
      margin: 10px 0 6px;
    }

    input,
    .addr-box {
      width: 100%;
      padding: 12px 12px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.08);
      color: #fff;
      outline: none;
    }

    .split {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-top: 12px;
    }

    .rowline {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .mono {
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      word-break: break-all;
    }

    .mini {
      font-size: .9rem;
      opacity: .9;
    }

    .submit {
      margin-top: 14px;
      text-align: right;
    }

    .btn.secondary {
      background: #2a7de1;
      box-shadow: 0 8px 24px rgba(42,125,225,.35);
    }

    .error {
      color: #ffb4b4;
      font-size: .9rem;
      margin-top: 6px;
    }

    .ok {
      color: #b5ffcb;
      font-size: .9rem;
      margin-top: 6px;
    }

    /* Rank panel */
    .rank-panel {
      margin-top: 18px;
      background: rgba(0,0,0,.18);
      padding: 16px;
      border-radius: 14px;
    }

    .rank-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .rank-header-title {
      font-size: 1rem;
      font-weight: 600;
    }

    .rank-current-label {
      font-size: .85rem;
      opacity: .9;
    }

    .rank-tabs {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 10px;
    }

    .rank-tab {
      width: 100%;
      padding: 12px 14px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.06);
      color: #fff;
      font-size: .85rem;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      gap: 6px;
      position: relative;
      overflow: hidden;
    }

    .rank-name {
      font-weight: 600;
      font-size: .9rem;
    }

    .rank-percent {
      font-size: .8rem;
      opacity: .9;
    }

    .rank-status {
      font-size: .75rem;
      opacity: .85;
    }

    .rank-tab.achieved {
      border-color: #00c853;
      box-shadow:
        0 0 0 1px rgba(0,200,83,.4),
        0 0 16px rgba(0,200,83,.45);
    }

    .rank-tab.achieved::before {
      content: "";
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 5px;
      background: linear-gradient(
        180deg,
        rgba(0,200,83,1),
        rgba(0,200,83,0.1)
      );
    }

    .rank-tab.locked .rank-status {
      color: #ffb4b4;
    }

    .rank-tab.achieved .rank-status {
      color: #b5ffcb;
    }

    .rank-tab.active {
      box-shadow:
        0 0 0 1px rgba(255,255,255,.35),
        0 0 10px rgba(255,255,255,.25);
    }

    .rank-main {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2px;
    }

    .rank-progress {
      width: 100%;
      height: 6px;
      border-radius: 999px;
      background: rgba(255,255,255,.12);
      overflow: hidden;
      margin-top: 4px;
    }

    .rank-progress-bar {
      height: 100%;
      border-radius: inherit;
      background: linear-gradient(90deg,#00c853,#b2ff59);
      transform-origin: left;
    }

    .rank-progress-text {
      font-size: .75rem;
      opacity: .85;
      margin-top: 2px;
    }

    .rank-details {
      font-size: .9rem;
      line-height: 1.4;
    }

    .rank-details ul {
      padding-left: 18px;
      margin: 6px 0;
    }

    .rank-details li {
      margin: 2px 0;
    }
  </style>
</head>
<body>
 <div id="topMenu"
     style="display:none;position:fixed;top:14px;left:14px;z-index:9999;">
  <button id="menuBtn" class="btn" style="padding:6px 10px;">‚ò∞</button>
</div>

<div id="menuPopup" style="
  display:none;
  position:fixed;
  top:52px;
  left:14px;
  background:#1a1a2e;
  border-radius:10px;
  padding:10px;
  box-shadow:0 10px 30px rgba(0,0,0,.4);
  z-index:9999;
">
  <button class="btn secondary" id="menuUser">User Dashboard</button><br><br>
  <button class="btn secondary" id="menuAdmin" style="display:none;">
    Admin Dashboard
  </button>
</div>

<!-- APP CONTENT -->
<div class="card" id="app"></div>


  <img src="./Botologo_new.png"
       alt="MSTC EARNING PROJECT"
       class="logo"
       id="avatar" />

  <!-- REGISTRATION SECTION -->
  <div id="registerSection">
    <h2 id="accountStatus">Do you want to register?</h2>

    <div class="actions">
      <button id="yesBtn" class="btn" type="button">Yes</button>
      <button id="noBtn" class="btn alt" type="button">No</button>
    </div>
  </div>

</div>
    <!-- USER PAGE (rendered later) -->
    <div id="userPage" style="display:none;"></div>

    <!-- ADMIN PAGE (rendered later) -->
    <div id="adminPage" style="display:none;"></div>

  </div>

<script>
  // --- Referral from URL (?ref=...) ---
  const urlParams = new URLSearchParams(window.location.search);
  let ref =
    urlParams.get("ref") ||
    urlParams.get("tgWebAppStartParam") ||
    null;
  window.currentRef = ref;

  // --- Telegram WebApp object ---
  const tg = window.Telegram && window.Telegram.WebApp
    ? window.Telegram.WebApp
    : null;
    // --- TON Connect UI (global, only once) ---
const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
  manifestUrl: 'https://mstcbotnew-production.up.railway.app/static/tonconnect-manifest.json'
});

 async function saveTonWallet(address) {
    await fetch('/webapp/save_wallet', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        initData: tg.initData,
        ton_wallet: address
      })
    });
  }

async function connectTonWallet() {
    try {
      const wallet = await tonConnectUI.connectWallet();
      const address = wallet.account.address;

      console.log("TON wallet connected:", address);

      const el = document.getElementById('walletStatus');
      if (el) {
        el.textContent =
          'Connected: ' + address.slice(0, 6) + '...' + address.slice(-4);
      }

      // save to backend
      await saveTonWallet(address);

    } catch (e) {
      console.error('TON wallet connection failed', e);
    }
  }

function renderUserDashboard(userData) {
  const userPage = document.getElementById('userPage');
  const adminPage = document.getElementById('adminPage');

  if (!userPage || !userData) {
    console.error('User page or data missing');
    return;
  }

  // hide others
  adminPage.style.display = 'none';
  userPage.style.display = 'block';

  userPage.innerHTML = `
    <h2>üë§ User Dashboard</h2>

    <div class="panel">
      <h3>üìå Profile</h3>
      <div class="mini">Name: <b>${userData.first_name || '‚Äî'}</b></div>
      <div class="mini">Username: <b>@${userData.username || '‚Äî'}</b></div>
      <div class="mini">Role: <b>${userData.role || 'member'}</b></div>
      <div class="mini">
        Status:
        <b>${userData.self_activated ? 'Active ‚úÖ' : 'Inactive ‚ùå'}</b>
      </div>
    </div>

    <div class="panel">
      <h3>üèÖ Rank</h3>
      <div class="big">${computeRanks(userData).current}</div>
    </div>

    <div class="panel">
      <h3>üë• Team</h3>
      <div class="mini">
        Active Origins: <b>${userData.active_origin_count || 0}</b>
      </div>
      <div class="mini">
        Total Team Business: <b>$${(userData.total_team_business || 0).toFixed(2)}</b>
      </div>
    </div>

    <div class="panel">
      <h3>üîó Referral</h3>
      <div class="addr-box mono">
        https://t.me/mstcrefbot/mstcapp?start=${userData.id}
      </div>
    </div>

    <div class="submit">
      <button class="btn secondary" id="backToDeposit">
        ‚¨Ö Back to Deposit
      </button>
    </div>
  `;

  // back button
  document.getElementById('backToDeposit').onclick = () => {
    userPage.style.display = 'none';
    window.showRegisteredViewFromBackend();
  };
}  

function renderAdminDashboard(admin) {
  const adminPage = document.getElementById('adminPage');
  const userPage = document.getElementById('userPage');

  if (!adminPage || !userPage) {
    console.error('adminPage or userPage not found in HTML');
    return;
  }

  userPage.style.display = 'none';
  adminPage.style.display = 'block';

  adminPage.innerHTML = `
    <h2>üëë Admin Dashboard</h2>

    <div class="panel">
      <h3>üìä Overview</h3>

      <div class="split">
        <div class="panel">
          <div class="mini">Total Users</div>
          <div class="big" id="statUsers">‚Äî</div>
        </div>

        <div class="panel">
          <div class="mini">Total Deposits</div>
          <div class="big" id="statDeposits">‚Äî</div>
        </div>
      </div>

      <div class="panel" style="margin-top:12px;">
        <div class="mini">Company Pool (MUSD)</div>
        <div class="big" id="statPool">‚Äî</div>
      </div>
    </div>

    <div class="panel">
      <h3>üõ°Ô∏è Admin Info</h3>
      <div class="mini">Telegram ID: <b>${admin.id}</b></div>
      <div class="mini">Role: <b>${admin.role}</b></div>
    </div>
  `;

  loadAdminStats();
}

async function loadAdminStats() {
  const res = await fetch('/admin/stats', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ initData: tg.initData })
  });

  const data = await res.json();
  if (!data.ok) return;

  document.getElementById('statUsers').textContent = data.total_users;
  document.getElementById('statDeposits').textContent =
    '$' + data.total_deposits;
  document.getElementById('statPool').textContent =
    '$' + data.company_pool;
}

  const unsafe = tg ? tg.initDataUnsafe || {} : {};
  console.log("DEBUG initDataUnsafe:", unsafe);   // <<< IMPORTANT

  if (!ref && unsafe.start_param) {
      ref = unsafe.start_param;
      window.currentRef = ref;
      console.log("REF captured from Telegram start_param:", ref);
  }

  try {
    tg && tg.ready();
    tg && tg.expand();
  } catch (e) {}

  //const app = document.getElementById('app');
  const baseLogo = './Botologo_new.png';

  function showTopMenu() {
  const menu = document.getElementById('topMenu');
  if (menu) menu.style.display = 'block';
}

function hideTopMenu() {
  const menu = document.getElementById('topMenu');
  const popup = document.getElementById('menuPopup');
  if (menu) menu.style.display = 'none';
  if (popup) popup.style.display = 'none';
}  

  // Token addresses and labels
  const ADDR_MUSD = "0x7e6916Af95714BE309cF3eee98149074921D93e0";
  const ADDR_MSTC = "0x7e6916Af95714BE309cF3eee98149074921D93e0";
  const CHAIN_LABEL = "EVM Chain";

  function copyText(txt, tip) {
    navigator.clipboard.writeText(txt).then(() => {
      tip.classList.add('show');
      setTimeout(() => tip.classList.remove('show'), 1200);
    }).catch(() => alert('Copy failed'));
  }

  function fmt(n) {
    return Number(n).toFixed(2);
  }

  // --- Rank computation ---
  const computeRanks = (user) => {
    const total = Number(user.total_team_business || 0);
    const activeOrigins = Number(user.active_origin_count || 0);
    const role = user.role || '';
    const selfActivated = !!user.self_activated;

    const isOrigin = selfActivated || role === 'origin';
    const isLifeChanger = total >= 1000 && activeOrigins >= 10;
    const isAdvisor = total >= 5000;
    const isVisionary = total >= 25000;
    const isCreator = total >= 100000;

    let current = 'Member';
    if (isCreator) current = 'Creator';
    else if (isVisionary) current = 'Visionary';
    else if (isAdvisor) current = 'Advisor';
    else if (isLifeChanger) current = 'Life Changer';
    else if (isOrigin) current = 'Origin';

    return {
      isOrigin,
      isLifeChanger,
      isAdvisor,
      isVisionary,
      isCreator,
      total,
      activeOrigins,
      current
    };
  };

  // --- Verify with backend; fallback to Telegram user ---
  async function verifyInitData() {
  const tgApp = window.Telegram?.WebApp || null;

  /* -------------------------------
     1Ô∏è‚É£ BROWSER MODE (NO TELEGRAM)
  --------------------------------*/
  if (!tgApp || !tgApp.initData) {
    console.warn('Browser mode detected ‚Äì skipping backend verify');

    return {
      ok: true,
      user: {
        id: 123456,
        first_name: 'Browser',
        username: 'test_user',
        photo_url: null,
        role: 'origin',
        self_activated: true,
        total_team_business: 20,
        active_origin_count: 0
      }
    };
  }

  /* -------------------------------
     2Ô∏è‚É£ TELEGRAM MODE
  --------------------------------*/
  const initData = tgApp.initData;
  const unsafe = tgApp.initDataUnsafe || {};
  const unsafeUser = unsafe.user || null;

  // referral
  const startParam = unsafe.start_param || unsafe.startParam || null;
  if (!window.currentRef && startParam) {
    window.currentRef = startParam;
  }

  const effectiveRef = window.currentRef || null;

  console.log('üöÄ Sending to /webapp/me:', { initData, ref: effectiveRef });

  try {
    const res = await fetch('/webapp/me', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        initData,
        ref: effectiveRef
      })
    });

    const data = await res.json();

    if (!res.ok || !data.ok) {
      throw new Error(data.error || 'verify failed');
    }

    return data;
  } catch (err) {
    console.warn('verify failed, fallback to unsafe user', err);
    return { ok: false, user: unsafeUser || {} };
  }
}

/* expose globally (important for YES button) */
window.verifyInitData = verifyInitData;

  // --- Render full registered view (deposit + ranks) ---
  const renderRegisteredView = (uid, name, avatar, userData) => {
    showTopMenu();
  // üîí SAFETY: ensure backend user data is present
  if (!userData || typeof userData !== 'object') {
    console.error("renderRegisteredView called without userData", userData);
    if (tg) tg.showAlert("User data missing. Please reopen the app.");
    return;
  }

  // üîç DEBUG (remove later if you want)
  console.log("RENDER USER DATA:", userData);
    
    const ranks = computeRanks(userData || {});

    const total = ranks.total.toFixed(2);
    const activeOrigins = ranks.activeOrigins;

    const originProgress = ranks.isOrigin ? 100 : 0;

    const lcBusiness = Math.min(ranks.total / 1000, 1);
    const lcOrigins = Math.min(ranks.activeOrigins / 10, 1);
    const lifeChangerProgress = ranks.isLifeChanger
      ? 100
      : Math.round(Math.min((lcBusiness + lcOrigins) / 2, 1) * 100);

    const advisorProgress = ranks.isAdvisor
      ? 100
      : Math.round(Math.min(ranks.total / 5000, 1) * 100);

    const visionaryProgress = ranks.isVisionary
      ? 100
      : Math.round(Math.min(ranks.total / 25000, 1) * 100);

    const creatorProgress = ranks.isCreator
      ? 100
      : Math.round(Math.min(ranks.total / 100000, 1) * 100);

    // referral link for this uid
    const refLink = `https://t.me/mstcrefbot/mstcapp?start=${uid}`;

    app.innerHTML = `
      <img src="${avatar || baseLogo}" class="logo glow" />
      <div class="row big">${uid ?? '(unknown)'}</div>
      <div class="row">${name || 'Unknown'}</div>
      <div class="row mini">
      <!--  Total Team Business:
        <b>$${total}</b>
        ¬∑ Active Origins:
        <b>${activeOrigins}</b>-->
        Current: <b>${ranks.current}</b>
      </div>

      <div class="row ref-line">
        <span class="mini">Referral Link</span>
        <button class="copy-btn" id="copyRef">üìã</button>
      </div>
      <div class="tooltip" id="tipRef">Copied!</div>

      <div class="panel">
  <h3>üîó TON Wallet</h3>
  <button class="btn secondary" id="connectWalletBtn">
    Connect TON Wallet
  </button>
  <div id="walletStatus" class="mini"></div>
</div>

      <div class="panel">
        <h3>üí≥ Deposit</h3>
        <div class="mini">Minimum deposit ‚Äî <b>$20</b>.</div>

        <label>Enter USD amount</label>
        <input id="amt" type="number" min="20" step="0.01" placeholder="e.g., 20.00" />
        <div id="err" class="error" style="display:none;"></div>

        <div class="split">
          <div>
            <div class="mini">MUSD (70%)</div>
            <div class="rowline">
              <span id="musdAmt" class="big">0.00</span>
              <span class="mini">USD</span>
            </div>

            <label class="mini" style="margin-top:8px;">Send to (MUSD address)</label>
            <div class="addr-box mono">${ADDR_MUSD}</div>
            <div class="rowline" style="margin-top:6px;">
              <button class="copy-btn" id="copyMUSD">üìã</button>
              <span class="mini">${CHAIN_LABEL}</span>
            </div>

            <label class="mini" style="margin-top:8px;">MUSD Tx Hash</label>
            <input id="txMUSD" type="text" placeholder="Paste transaction hash" />
          </div>

          <div>
            <div class="mini">MSTC (30%)</div>
            <div class="rowline">
              <span id="mstcAmt" class="big">0.00</span>
              <span class="mini">USD</span>
            </div>

            <label class="mini" style="margin-top:8px;">Send to (MSTC address)</label>
            <div class="addr-box mono">${ADDR_MSTC}</div>
            <div class="rowline" style="margin-top:6px;">
              <button class="copy-btn" id="copyMSTC">üìã</button>
              <span class="mini">${CHAIN_LABEL}</span>
            </div>

            <label class="mini" style="margin-top:8px;">MSTC Tx Hash</label>
            <input id="txMSTC" type="text" placeholder="Paste transaction hash" />
          </div>
        </div>

        <div class="submit">
          <button class="btn secondary" id="submitDeposit">Submit Deposit</button>
        </div>
        <div id="submitMsg" class="ok" style="display:none;"></div>
      </div>

      <div class="rank-panel">
        <div class="rank-header">
        <div class="rank-header-title">üèÖ Your Rank & Levels</div>
          <div class="rank-current-label">
           <!-- Current: <b>${ranks.current}</b> -->
          </div>
        </div>

        <div class="rank-tabs">
          <button
            class="rank-tab ${ranks.isOrigin ? 'achieved' : 'locked'}"
            data-rank="origin"
          >
            <div class="rank-main">
              <span class="rank-name">Origin</span>
             <!-- <span class="rank-percent">5% Level Income</span>
              <span class="rank-status">
                ${ranks.isOrigin ? 'Achieved' : 'Locked'}-->
              </span> 
            </div>
            <div class="rank-progress">
          <!--    <div
                class="rank-progress-bar"
                style="width:${originProgress}%;"
              ></div>
            </div>
            <div class="rank-progress-text">
              ${originProgress}% ${originProgress === 100 ? 'achieved' : 'to unlock'}
            </div>-->
          </button>

          <button
            class="rank-tab ${ranks.isLifeChanger ? 'achieved' : 'locked'}"
            data-rank="life_changer"
          >
            <div class="rank-main">
              <span class="rank-name">Life Changer</span>
             <!-- <span class="rank-percent">10% Direct</span>
              <span class="rank-status">
                ${ranks.isLifeChanger ? 'Achieved' : 'Locked'}-->
              </span>
            </div>
            <div class="rank-progress">
           <!--   <div
                class="rank-progress-bar"
                style="width:${lifeChangerProgress}%;"
              ></div>
            </div>
            <div class="rank-progress-text">
              ${lifeChangerProgress}% ${lifeChangerProgress === 100 ? 'achieved' : 'towards next rank'}
            </div>-->
          </button>

          <button
            class="rank-tab ${ranks.isAdvisor ? 'achieved' : 'locked'}"
            data-rank="advisor"
          >
            <div class="rank-main">
              <span class="rank-name">Advisor</span>
              <!--<span class="rank-percent">15% Club Rank</span>
              <span class="rank-status">
                ${ranks.isAdvisor ? 'Achieved' : 'Locked'}-->
              </span>
            </div>
            <div class="rank-progress">
            <!--  <div
                class="rank-progress-bar"
                style="width:${advisorProgress}%;"
              ></div>
            </div>
            <div class="rank-progress-text">
              ${advisorProgress}% ${advisorProgress === 100 ? 'achieved' : 'towards next rank'}
            </div>-->
          </button>

          <button
            class="rank-tab ${ranks.isVisionary ? 'achieved' : 'locked'}"
            data-rank="visionary"
          >
            <div class="rank-main">
              <span class="rank-name">Visionary</span>
            <!--  <span class="rank-percent">20% Club Rank</span>
              <span class="rank-status">
                ${ranks.isVisionary ? 'Achieved' : 'Locked'}-->
              </span>
            </div>
            <div class="rank-progress">
             <!-- <div
                class="rank-progress-bar"
                style="width:${visionaryProgress}%;"
              ></div>
            </div>
            <div class="rank-progress-text">
              ${visionaryProgress}% ${visionaryProgress === 100 ? 'achieved' : 'towards next rank'}
            </div>-->
          </button>

          <button
            class="rank-tab ${ranks.isCreator ? 'achieved' : 'locked'}"
            data-rank="creator"
          >
            <div class="rank-main">
              <span class="rank-name">Creator</span>
              <!--<span class="rank-percent">25% Top Rank</span>
              <span class="rank-status">
                ${ranks.isCreator ? 'Achieved' : 'Locked'}-->
              </span>
            </div>
            <div class="rank-progress">
           <!--   <div
                class="rank-progress-bar"
                style="width:${creatorProgress}%;"
              ></div>
            </div>
            <div class="rank-progress-text">
              ${creatorProgress}% ${creatorProgress === 100 ? 'achieved' : 'towards top rank'}-->
            </div>
          </button>
        </div>

        <div id="rankDetails" class="rank-details"></div>
      </div>
    `;

    // --- ADMIN MENU VISIBILITY ---
const adminBtn = document.getElementById('menuAdmin');

if (adminBtn) {
  if (userData.is_admin) {
    adminBtn.style.display = 'block';
  } else {
    adminBtn.style.display = 'none';
  }
}

     const connectBtn = document.getElementById('connectWalletBtn');
  if (connectBtn) {
    connectBtn.onclick = connectTonWallet;
  }
const menuUserBtn = document.getElementById('menuUser');
if (menuUserBtn) {
  menuUserBtn.onclick = () => {
    renderUserDashboard(userData);
    document.getElementById('menuPopup').style.display = 'none';
  };
}
    // --- Wire up events inside rendered view ---

    const tip = document.getElementById('tipRef');
    const copyRefBtn = document.getElementById('copyRef');
    if (copyRefBtn && tip) {
      copyRefBtn.onclick = () => copyText(refLink, tip);
    }

    const amtInput = document.getElementById('amt');
    const musdAmt = document.getElementById('musdAmt');
    const mstcAmt = document.getElementById('mstcAmt');
    const errEl = document.getElementById('err');

    if (amtInput && musdAmt && mstcAmt && errEl) {
      amtInput.oninput = () => {
        const v = parseFloat(amtInput.value || '0');
        if (isNaN(v) || v <= 0) {
          musdAmt.textContent = '0.00';
          mstcAmt.textContent = '0.00';
          errEl.style.display = 'none';
          errEl.textContent = '';
          return;
        }

        musdAmt.textContent = fmt(v * 0.70);
        mstcAmt.textContent = fmt(v * 0.30);

        if (v < 20) {
          errEl.style.display = 'block';
          errEl.textContent = 'Minimum deposit is $20.';
        } else {
          errEl.style.display = 'none';
          errEl.textContent = '';
        }
      };
    }

    const tipCopy = document.getElementById('tipRef');
    const copyMUSDBtn = document.getElementById('copyMUSD');
    const copyMSTCBtn = document.getElementById('copyMSTC');

    if (copyMUSDBtn && tipCopy) {
      copyMUSDBtn.onclick = () => copyText(ADDR_MUSD, tipCopy);
    }
    if (copyMSTCBtn && tipCopy) {
      copyMSTCBtn.onclick = () => copyText(ADDR_MSTC, tipCopy);
    }

    const submitBtn = document.getElementById('submitDeposit');
    const msgEl = document.getElementById('submitMsg');
    const txMUSDInput = document.getElementById('txMUSD');
    const txMSTCInput = document.getElementById('txMSTC');

    if (submitBtn && amtInput && errEl && msgEl && txMUSDInput && txMSTCInput) {
      submitBtn.onclick = async () => {
        const tgApp = tg;

        // Clear previous messages
        errEl.style.display = 'none';
        errEl.textContent = '';
        msgEl.style.display = 'none';
        msgEl.textContent = '';

        const valueStr = amtInput.value ? amtInput.value.trim() : "0";
        const amount = parseFloat(valueStr || "0");

        const tx1 = txMUSDInput.value.trim();
        const tx2 = txMSTCInput.value.trim();

        if (isNaN(amount) || amount < 20) {
          errEl.style.display = 'block';
          errEl.textContent = 'Please enter at least $20.';
          if (tgApp) {
            tgApp.showAlert('Please enter at least $20.');
          }
          return;
        }

        if (!tx1 || !tx2) {
          errEl.style.display = 'block';
          errEl.textContent = 'Please paste both transaction hashes.';
          if (tgApp) {
            tgApp.showAlert('Please paste both transaction hashes.');
          }
          return;
        }

        // --- Use two-step flow: /webapp/me then /deposit/submit ---
        const initData = tgApp ? tgApp.initData : "";
        msgEl.style.display = 'block';
        msgEl.textContent = 'Verifying user...';

        try {
          const meRes = await fetch('/webapp/me', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ initData, ref: window.currentRef || null })
          });

          const meText = await meRes.text();
          let meJson = null;
          try { meJson = meText ? JSON.parse(meText) : null; } catch(e) { throw new Error('Failed parsing /webapp/me JSON: ' + e.message + ' => ' + meText.slice(0,1000)); }

          if (!meRes.ok || !meJson || meJson.ok === false) {
            const err = (meJson && (meJson.error || meJson.detail)) || `HTTP ${meRes.status}`;
            throw new Error('/webapp/me failed: ' + err);
          }

          const userId = (meJson.user && meJson.user.id) || meJson.user_id || (meJson && meJson.telegram_id && parseInt(meJson.telegram_id));
          if (!userId) throw new Error('Could not determine user id from /webapp/me response.');

          // 2) Submit deposit to /deposit/submit
          msgEl.textContent = 'Submitting deposit...';

          const depositPayload = {
            user_id: userId,
            amount: Number(amount.toFixed(2)),
            tx_musd: tx1,
            tx_mstc: tx2,
            ref: window.currentRef || null
          };

          const depositRes = await fetch('/deposit/submit', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(depositPayload)
          });

          const depositText = await depositRes.text();
          let depositJson = null;
          try { depositJson = depositText ? JSON.parse(depositText) : null; } catch(e) { throw new Error('Failed parsing /deposit/submit JSON: ' + e.message + ' => ' + depositText.slice(0,1000)); }

          if (!depositRes.ok || !depositJson || depositJson.ok === false) {
            const err = (depositJson && (depositJson.error || depositJson.detail)) || `HTTP ${depositRes.status}`;
            throw new Error('/deposit/submit failed: ' + err + '\n\n' + depositText.slice(0,1000));
          }

          // success ‚Äî show summary
          const summaryLines = [];
          if (Array.isArray(depositJson.referral_dist) && depositJson.referral_dist.length) {
            depositJson.referral_dist.forEach(r => {
              const level = (r.level === 0 || r.level === null || r.level === undefined) ? 'Pool' : 'Level ' + r.level;
              summaryLines.push(`${level}: ${r.to_user || r.to_user_id || 'unknown'} ‚Üí $${r.amount}`);
            });
          } else {
            summaryLines.push('No referral distribution.');
          }

          const summaryText = summaryLines.join('\n');
          if (tgApp) tgApp.showAlert('Deposit submitted successfully!\n\n' + summaryText);

          msgEl.style.display = 'block';
          msgEl.innerHTML ='Deposit submitted successfully!<br><pre style="text-align:left; white-space:pre-wrap;">' +
          summaryText +
          '</pre>';

await loadFullUserAndRender();
showTopMenu();   

          // clear fields
          amtInput.value = '';
          txMUSDInput.value = '';
          txMSTCInput.value = '';
          musdAmt.textContent = '0.00';
          mstcAmt.textContent = '0.00';

        } catch (e) {
          const errorText = e && e.message ? e.message : String(e);
          if (tgApp) {
            tgApp.showAlert('Failed to submit: ' + errorText);
          }
          msgEl.style.display = 'block';
          msgEl.textContent = 'Failed to submit: ' + errorText;
          console.error('submit error:', e);
        }
      };
    }

    // --- Rank tab details ---
    const rankDetails = document.getElementById('rankDetails');
    const rankTabs = app.querySelectorAll('.rank-tab');

    function setActiveRankTab(rankKey) {
      rankTabs.forEach(btn => {
        if (btn.dataset.rank === rankKey) {
          btn.classList.add('active');
        } else {
          btn.classList.remove('active');
        }
      });

      let html = '';
      if (rankKey === 'origin') {
        html = `
          <b>Origin ‚Äì 5% Level Income</b>
          <ul>
            <li>Self activation required (your own qualifying deposit).</li>
            <li>You start earning 5% from your direct team as Origin.</li>
          </ul>
        `;
      } else if (rankKey === 'life_changer') {
        html = `
          <b>Life Changer ‚Äì 10% Direct</b>
          <ul>
            <li>1000 MUSD total team business.</li>
            <li>10 active Origins in your group.</li>
            <li>Eligible for Life Changer club and monthly pool
                (2% company turnover shared among achievers ‚Äì handled by admin).</li>
          </ul>
        `;
      } else if (rankKey === 'advisor') {
        html = `
          <b>Advisor ‚Äì 15%</b>
          <ul>
            <li>5000 MUSD total team business (target).</li>
            <li>Higher monthly club requirements decided by company rules.</li>
            <li>2% company club pool shared among all active Advisors (as per plan).</li>
          </ul>
        `;
      } else if (rankKey === 'visionary') {
        html = `
          <b>Visionary ‚Äì 20%</b>
          <ul>
            <li>25000 MUSD total team business (target).</li>
            <li>Next-level leadership and club participation.</li>
          </ul>
        `;
      } else if (rankKey === 'creator') {
        html = `
          <b>Creator ‚Äì 25%</b>
          <ul>
            <li>100000 MUSD total team business (top rank target).</li>
            <li>Highest reward slab and special company recognition.</li>
          </ul>
        `;
      }

      if (rankDetails) {
        rankDetails.innerHTML = html;
      }
    }

    let defaultRank = 'origin';
    if (ranks.isCreator) defaultRank = 'creator';
    else if (ranks.isVisionary) defaultRank = 'visionary';
    else if (ranks.isAdvisor) defaultRank = 'advisor';
    else if (ranks.isLifeChanger) defaultRank = 'life_changer';

    setActiveRankTab(defaultRank);

    rankTabs.forEach(btn => {
      btn.addEventListener('click', () => {
        setActiveRankTab(btn.dataset.rank);
      });
    });
  };

  // expose renderRegisteredView globally
  window.renderRegisteredView = renderRegisteredView;

  // --- Helper: show full view from backend (YES or auto for registered users) ---
  async function showRegisteredViewFromBackend() {
  let verifyResp = null;

  try {
    verifyResp = await verifyInitData();
  } catch (e) {
    console.warn('verifyInitData failed, falling back', e);
  }

  const tgApp = tg;
  const unsafeUser =
    tgApp && tgApp.initDataUnsafe && tgApp.initDataUnsafe.user
      ? tgApp.initDataUnsafe.user
      : {};

  const userData = (verifyResp && verifyResp.user) || unsafeUser || {};

  const id = userData.id || userData.telegram_id || 0;
  const name =
    ((userData.first_name || '') +
      (userData.username ? ' @' + userData.username : '')) ||
    'Unknown';

  const avatar = userData.photo_url || baseLogo;

  renderRegisteredView(id, name, avatar, userData);
}

// expose globally
window.showRegisteredViewFromBackend = showRegisteredViewFromBackend;

  // --- Activation status (first screen, Yes/No) ---
  function updateActivationStatus(user) {
    const statusEl = document.getElementById("accountStatus");
    const registerSection = document.getElementById("registerSection");
    if (!user || !statusEl || !registerSection) return;

    if (!user.has_registered) {
      // FIRST TIME USER ‚Äì show question + Yes/No
      statusEl.textContent = "Do you want to register?";
      registerSection.style.display = "";
    } else {
      // REGISTERED USER ‚Äì hide question
      registerSection.style.display = "none";
      if (user.is_active) {
        statusEl.textContent = "You are activated as Origin ‚úÖ";
      } else {
        statusEl.textContent =
          "You are registered but not activated yet. Deposit at least $20 to activate Origin.";
      }
    }
  }

  const loadActivationStatus = async () => {

    hideTopMenu(); // ‚úÖ HIDE MENU ON REGISTRATION PAGE
    const tgApp = tg;
    if (!tgApp) {
      console.error("Telegram WebApp not available");
      return;
    }

    const initData = tgApp.initData || "";

    try {
      const res = await fetch('/webapp/init', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          initData,
          ref: window.currentRef || null
        })
      });
      const data = await res.json();
      console.log("VERIFY RESPONSE:", data);

      if (data && data.ok !== false) {
        updateActivationStatus(data);

        // if user already registered, skip question and show full view
        if (data.has_registered) {
          await loadFullUserAndRender();
        showTopMenu();
        }
      } else {
        console.error("init failed", data);
      }
    } catch (err) {
      console.error("Error loading activation status:", err);
    }
  };

async function loadFullUserAndRender() {
  if (!tg) {
    console.error("Telegram WebApp not available");
    return;
  }

  const res = await fetch('/webapp/user', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      initData: tg.initData
    })
  });

  const data = await res.json();

  if (!data.ok) {
    console.error("Failed to load full user", data);
    return;
  }

  const u = data.user;

  const name =
    ((u.first_name || '') +
      (u.username ? ' @' + u.username : '')) ||
    'Unknown';

  renderRegisteredView(
    u.id,
    name,
    null,
    u            // üî• FULL, FRESH DB USER
  );
}

document.addEventListener('click', async (e) => {
  const yesBtn = e.target.closest('#yesBtn');
  if (!yesBtn) return;

  e.preventDefault();

  try {
    await showRegisteredViewFromBackend();
  } catch (err) {
    console.error('YES click failed:', err);
    if (window.Telegram?.WebApp) {
      Telegram.WebApp.showAlert(
        'Failed to open app: ' +
        (err.message || 'Unknown error')
      );
    }
  }
});

 let app = null;

  document.addEventListener('DOMContentLoaded', () => {

    
    // --- ROOT APP ---
    app = document.getElementById('app');

    if (!app) {
      console.error('‚ùå #app container not found');
      return;
    }

    console.log('‚úÖ #app container ready');

    // ============================
    // YES BUTTON (delegation)
    // ============================
    document.addEventListener('click', (e) => {
      const yes = e.target && e.target.closest && e.target.closest('#yesBtn');
      if (!yes) return;

      e.preventDefault();

      if (typeof window.showRegisteredViewFromBackend === 'function') {
        window.showRegisteredViewFromBackend().catch(err => {
          console.error('showRegisteredViewFromBackend failed:', err);
          if (window.Telegram && window.Telegram.WebApp) {
            window.Telegram.WebApp.showAlert(
              'Failed to open app: ' +
              (err && err.message ? err.message : String(err))
            );
          }
        });
      } else {
        console.warn('showRegisteredViewFromBackend not found on window');
      }
    });

    // ============================
    // üçî HAMBURGER MENU WIRING
    // ============================
    const menuBtn = document.getElementById('menuBtn');
    const popup = document.getElementById('menuPopup');

    if (!menuBtn || !popup) {
      console.warn('Hamburger menu elements not found');
      return;
    }

    menuBtn.onclick = () => {
      popup.style.display =
        popup.style.display === 'block' ? 'none' : 'block';
    };
  });
  
</script>
</body>
</html>
