<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MSTC Earning Project ‚Äî Deposit & Reward System</title>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>

  <style>
    * { box-sizing: border-box; }

    body {
      margin: 0;
      min-height: 100vh;
      display: block; /* content flows from top */
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
      text-align: center;
      color: #fff;
      background:
        radial-gradient(1200px 600px at 50% -20%, rgba(255,255,255,.08), transparent 60%),
        linear-gradient(135deg, #5c3cff, #0e1630 60%);
      overflow-y: auto;
      overflow-x: hidden;
      padding: 12px 10px 24px;
    }

    .card {
      width: min(720px, 96vw);
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.15);
      border-radius: 20px;
      padding: 22px;
      box-shadow: 0 18px 50px rgba(0,0,0,.25);
      backdrop-filter: blur(6px);
      margin: 8px auto 24px;
    }

    .logo {
      width: 88px;
      height: 88px;
      border-radius: 50%;
      object-fit: cover;
      border: 4px solid rgba(255,255,255,.35);
      margin: 0 auto 14px;
      display: block;
      box-shadow:
        0 10px 26px rgba(0,0,0,.35),
        0 0 0 8px rgba(255,255,255,.08) inset;
      position: relative;
    }

    .logo.glow {
      border-color: transparent;
      box-shadow: none;
      isolation:isolate;
    }

    .logo.glow::before,
    .logo.glow::after {
      content: "";
      position: absolute;
      inset: -6px;
      border-radius: 50%;
      z-index: -1;
    }

    .logo.glow::before {
      background: conic-gradient(
        from 0deg,
        #6cf 0%,
        #8af 25%,
        #9ff 50%,
        #7df 75%,
        #6cf 100%
      );
      filter: blur(6px);
      animation: spin 4s linear infinite;
      opacity: .95;
    }

    .logo.glow::after {
      inset: -14px;
      background: radial-gradient(
        closest-side,
        rgba(108,240,255,.5),
        rgba(0,0,0,0)
      );
      filter: blur(10px);
      opacity: .65;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    h2 {
      margin: 0 0 10px;
      font-weight: 700;
    }

    .row {
      margin: 10px 0;
      font-size: 1.05rem;
    }

    .big {
      font-size: 1.25rem;
      font-weight: 700;
    }

    .actions {
      margin-top: 16px;
      display: flex;
      gap: 12px;
      justify-content: center;
    }

    .btn {
      padding: 11px 22px;
      border-radius: 22px;
      border: 0;
      cursor: pointer;
      font-weight: 600;
      background: #00c853;
      color: #fff;
      box-shadow: 0 8px 24px rgba(0,200,83,.35);
    }

    .btn.alt {
      background: #e53935;
      box-shadow: 0 8px 24px rgba(229,57,53,.35);
    }

    .ref-line {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      margin-top: 8px;
    }

    .copy-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 36px;
      height: 36px;
      border-radius: 10px;
      border: none;
      cursor: pointer;
      background: rgba(255,255,255,.16);
      color: #fff;
      font-size: 18px;
      transition: transform .12s ease, opacity .2s;
    }

    .copy-btn:active {
      transform: scale(.96);
    }

    .tooltip {
      margin-top: 8px;
      font-size: .85rem;
      opacity: 0;
      transition: opacity .25s;
    }

    .show {
      opacity: 1;
    }

    .panel {
      margin-top: 18px;
      text-align: left;
      background: rgba(0,0,0,.18);
      padding: 16px;
      border-radius: 14px;
    }

    .panel h3 {
      margin: 0 0 10px;
      color: #fff;
    }

    label {
      display: block;
      font-size: .95rem;
      opacity: .9;
      margin: 10px 0 6px;
    }

    input,
    .addr-box {
      width: 100%;
      padding: 12px 12px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.08);
      color: #fff;
      outline: none;
    }

    .split {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-top: 12px;
    }

    .rowline {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .mono {
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      word-break: break-all;
    }

    .mini {
      font-size: .9rem;
      opacity: .9;
    }

    .submit {
      margin-top: 14px;
      text-align: right;
    }

    .btn.secondary {
      background: #2a7de1;
      box-shadow: 0 8px 24px rgba(42,125,225,.35);
    }

    .error {
      color: #ffb4b4;
      font-size: .9rem;
      margin-top: 6px;
    }

    .ok {
      color: #b5ffcb;
      font-size: .9rem;
      margin-top: 6px;
    }

    /* Rank panel */
    .rank-panel {
      margin-top: 18px;
      background: rgba(0,0,0,.18);
      padding: 16px;
      border-radius: 14px;
    }

    .rank-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .rank-header-title {
      font-size: 1rem;
      font-weight: 600;
    }

    .rank-current-label {
      font-size: .85rem;
      opacity: .9;
    }

    .rank-tabs {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 10px;
    }

    .rank-tab {
      width: 100%;
      padding: 12px 14px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.06);
      color: #fff;
      font-size: .85rem;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      gap: 6px;
      position: relative;
      overflow: hidden;
    }

    .rank-name {
      font-weight: 600;
      font-size: .9rem;
    }

    .rank-percent {
      font-size: .8rem;
      opacity: .9;
    }

    .rank-status {
      font-size: .75rem;
      opacity: .85;
    }

    .rank-tab.achieved {
      border-color: #00c853;
      box-shadow:
        0 0 0 1px rgba(0,200,83,.4),
        0 0 16px rgba(0,200,83,.45);
    }

    .rank-tab.achieved::before {
      content: "";
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 5px;
      background: linear-gradient(
        180deg,
        rgba(0,200,83,1),
        rgba(0,200,83,0.1)
      );
    }

    .rank-tab.locked .rank-status {
      color: #ffb4b4;
    }

    .rank-tab.achieved .rank-status {
      color: #b5ffcb;
    }

    .rank-tab.active {
      box-shadow:
        0 0 0 1px rgba(255,255,255,.35),
        0 0 10px rgba(255,255,255,.25);
    }

    .rank-main {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2px;
    }

    .rank-progress {
      width: 100%;
      height: 6px;
      border-radius: 999px;
      background: rgba(255,255,255,.12);
      overflow: hidden;
      margin-top: 4px;
    }

    .rank-progress-bar {
      height: 100%;
      border-radius: inherit;
      background: linear-gradient(90deg,#00c853,#b2ff59);
      transform-origin: left;
    }

    .rank-progress-text {
      font-size: .75rem;
      opacity: .85;
      margin-top: 2px;
    }

    .rank-details {
      font-size: .9rem;
      line-height: 1.4;
    }

    .rank-details ul {
      padding-left: 18px;
      margin: 6px 0;
    }

    .rank-details li {
      margin: 2px 0;
    }

    /* ===== Deposit Header ===== */
.deposit-header {
  display: flex;
  align-items: center;
  padding: 10px 12px;
  position: relative;
}

.deposit-title {
  flex: 1;
  text-align: center;
  font-weight: 600;
}

/* ===== Hamburger Button ===== */
.hamburger {
  font-size: 22px;
  background: none;
  border: none;
  color: #fff;
  cursor: pointer;
}

/* ===== Side Menu ===== */
.side-menu {
  position: fixed;
  top: 0;
  left: -260px;
  width: 260px;
  height: 100vh;
  background: #121a3a;
  color: #fff;
  z-index: 1001;
  transition: left 0.25s ease;
  box-shadow: 4px 0 15px rgba(0,0,0,0.4);
}

/* Open state */
.side-menu.open {
  left: 0;
}

/* Menu Header */
.menu-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 14px;
  font-weight: bold;
  border-bottom: 1px solid rgba(255,255,255,0.1);
}

.menu-header button {
  background: none;
  border: none;
  color: #fff;
  font-size: 18px;
  cursor: pointer;
}

/* Menu Items */
.menu-content {
  padding: 10px;
}

.menu-item {
  padding: 12px;
  margin-bottom: 6px;
  background: rgba(255,255,255,0.05);
  border-radius: 8px;
  cursor: pointer;
}

.menu-item:hover {
  background: rgba(255,255,255,0.12);
}

.menu-item.logout {
  background: rgba(255,0,0,0.15);
}

/* ===== Overlay ===== */
.menu-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.45);
  z-index: 1000;
  display: none;
}

.menu-overlay.show {
  display: block;
}

.modal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.6);
  z-index: 2000;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 12px; /* IMPORTANT for small screens */
}

.modal.hidden {
  display: none;
}

.modal-card {
  width: 100%;
  max-width: 420px;
  max-height: 85vh;              /* üîë LIMIT HEIGHT */
  background: #121a3a;
  border-radius: 14px;
  display: flex;                 /* üîë FLEX LAYOUT */
  flex-direction: column;
  overflow: hidden;              /* hide overflow, body scrolls */
}

/* Header stays fixed */
.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px 12px;
  font-weight: bold;
  border-bottom: 1px solid rgba(255,255,255,.1);
  flex-shrink: 0;                /* üîë NEVER SCROLL */
}

/* Scrollable body */
.modal-body {
  padding: 12px;
  font-size: 14px;
  overflow-y: auto;              /* üîë SCROLL ENABLED */
  -webkit-overflow-scrolling: touch;
}

.user-header {
  text-align: center;
  margin-bottom: 16px;
}

.modal-header button {
  background: none;
  border: none;
  color: #fff;
  font-size: 18px;
  cursor: pointer;
  padding: 4px 8px;
}

.admin-user-row {
  padding: 10px;
  border-bottom: 1px solid rgba(255,255,255,.1);
  font-size: 14px;
}

.admin-user-row:last-child {
  border-bottom: none;
}
  </style>
</head>
<body>
  <div class="card" id="app">
    <img src="./Botologo_new.png"
         alt="MSTC EARNING PROJECT"
         class="logo"
         id="avatar" />

    <!-- Registration question + Yes/No; hidden later for registered users -->
    <div id="registerSection">
      <h2 id="accountStatus">Do you want to register?</h2>
      <div class="actions">
        <button id="yesBtn" class="btn" onclick="doRegister()">Yes</button>
        <button id="noBtn" class="btn alt" type="button">No</button>
      </div>
    </div>
  </div>

  <div id="modal" class="modal hidden">
  <div class="modal-card">
    <div class="modal-header">
      <span id="modalTitle"></span>
      <button onclick="closeModal()">‚úï</button>
    </div>
    <div id="modalBody" class="modal-body"></div>
  </div>
</div>

<script>

  document.addEventListener("click", (e) => {
  if (e.target.closest("#yesBtn")) {
    console.log("‚úÖ YES BUTTON CLICKED");
  }
});

  window.impersonation = {
  active: false,
  user: null
};

const BACKEND_URL = "https://mstcbotnew-production.up.railway.app";

  // --- Referral from URL (?ref=...) ---
  const urlParams = new URLSearchParams(window.location.search);
  let ref =
    urlParams.get("ref") ||
    urlParams.get("tgWebAppStartParam") ||
    null;
  window.currentRef = ref;

  // --- Telegram WebApp object ---
  const tg = window.Telegram && window.Telegram.WebApp
    ? window.Telegram.WebApp
    : null;

    // üîç Browser vs Telegram detection
if (!tg?.initData) {
  console.warn("‚ö†Ô∏è Browser mode detected (Telegram initData not available)");
}
    // --- TON Connect UI (global, only once) ---
const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
  manifestUrl: 'https://mstcbotnew-production.up.railway.app/static/tonconnect-manifest.json'
});

tonConnectUI.onStatusChange(wallet => {
  console.log("TON wallet status updated:", wallet);

  if (wallet?.account?.address) {
    saveTonWallet(wallet.account.address);
  }
});

tonConnectUI.setConnectRequestParameters({
  testnet: true
});

const TREASURY_TON_ADDRESS =
  "UQAZGsz5gaOVtAK67pITWUMUMYNMjccCSbMC5sAMx2say10K";


 let lastSavedWallet = null;

async function saveTonWallet(address) {
  if (!address || address === lastSavedWallet) return;

  const res = await fetch(BACKEND_URL + '/webapp/save_wallet', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      initData: tg.initData,
      ton_wallet: address
    })
  });

  if (res.ok) {
    lastSavedWallet = address;
  }
}

async function connectTonWallet() {

  console.log("üîµ TON connect button pressed");

  // if already connected ‚Üí show modal settings only
  if (tonConnectUI.wallet) {
    await tonConnectUI.openModal();
    return;
  }

  try {
    // open wallet modal & get wallet object
    const wallet = await tonConnectUI.connectWallet();

    // validate wallet
    if (!wallet?.account?.address) {
      console.warn("‚ö† Wallet returned without address");
      return;
    }

    const address = wallet.account.address;
    console.log("TON wallet connected:", address);

      // enable deposit button
    const submitBtn = document.getElementById("submitDeposit");
    if (submitBtn) {
      submitBtn.disabled = false;
      submitBtn.style.opacity = "1";
    }

    // save wallet to backend once
    await saveTonWallet(address);

  } catch (e) {
    console.error("TON wallet connection failed", e);
  }
}

async function sendTonDeposit(amountUsd) {

  // === 1Ô∏è‚É£ validate amount ===========================
  if (!amountUsd || amountUsd < 20) {
    throw new Error("Minimum deposit is $20");
  }

  // === 2Ô∏è‚É£ ignore real wallet requirement ============
  // (TONConnect wallet not required in simulator mode)
  if (!tonConnectUI.wallet?.account?.address) {
    console.warn("‚ö† SIM MODE: Wallet not connected, skipping check");
  }

  // === 3Ô∏è‚É£ simulate wallet open delay ================
  await new Promise(r => setTimeout(r, 1200));

  // === 4Ô∏è‚É£ generate deterministic tx hash ============
  const fakeHash =
    "SIMTX-" +
    Date.now().toString(36).toUpperCase() +
    "-" +
    Math.random().toString(36).substring(2, 8).toUpperCase();

  // === 5Ô∏è‚É£ show internally ===========================
  console.log(
    "‚ö° SIM TON TX CREATED",
    {
      hash: fakeHash,
      usd_amount: amountUsd,
      user: window.currentUserData?.id || "unknown"
    }
  );

  // === 6Ô∏è‚É£ return usable blockchain identifier ========
  return fakeHash;
}

  const unsafe = tg ? tg.initDataUnsafe || {} : {};
  console.log("DEBUG initDataUnsafe:", unsafe);   // <<< IMPORTANT

  if (!ref && unsafe.start_param) {
      ref = unsafe.start_param;
      window.currentRef = ref;
      console.log("REF captured from Telegram start_param:", ref);
  }

  try {
    tg && tg.ready();
    tg && tg.expand();
  } catch (e) {}

  const app = document.getElementById('app');
  const baseLogo = './Botologo_new.png';

  // Token addresses and labels
  const ADDR_MUSD = "0x7e6916Af95714BE309cF3eee98149074921D93e0";
  const ADDR_MSTC = "0x7e6916Af95714BE309cF3eee98149074921D93e0";
  const CHAIN_LABEL = "EVM Chain";

  function copyText(txt, tip) {
    navigator.clipboard.writeText(txt).then(() => {
      tip.classList.add('show');
      setTimeout(() => tip.classList.remove('show'), 1200);
    }).catch(() => alert('Copy failed'));
  }

  function fmt(n) {
    return Number(n).toFixed(2);
  }

  // --- Rank computation ---
  const computeRanks = (user) => {
    const total = Number(user.total_team_business || 0);
    const activeOrigins = Number(user.active_origin_count || 0);
    const role = user.role || '';
    const selfActivated = !!user.self_activated;

    const isOrigin = selfActivated || role === 'origin' || role === 'admin' || role === 'superadmin';

    const isLifeChanger = total >= 1000 && activeOrigins >= 10;
    const isAdvisor = total >= 5000;
    const isVisionary = total >= 25000;
    const isCreator = total >= 100000;

    let current = 'Member';
    if (role === 'admin' || role === 'superadmin') {
   current = 'Admin';
}
    if (isCreator) current = 'Creator';
    else if (isVisionary) current = 'Visionary';
    else if (isAdvisor) current = 'Advisor';
    else if (isLifeChanger) current = 'Life Changer';
    else if (isOrigin) current = 'Origin';

    return {
      isOrigin,
      isLifeChanger,
      isAdvisor,
      isVisionary,
      isCreator,
      total,
      activeOrigins,
      current
    };
  };

   
  const renderRegisteredView = (uid, name, avatar, userData) => {
  console.log("üü£ renderRegisteredView ENTERED", uid);

  // 1Ô∏è‚É£ store user globally
  window.currentUserData = userData;

  // 2Ô∏è‚É£ hide registration
  const reg = document.getElementById("registerSection");
  if (reg) reg.style.display = "none";

  // 3Ô∏è‚É£ show dashboard shell
  const app = document.getElementById("app");
  app.innerHTML = getDashboardSkeletonHTML();

  // 4Ô∏è‚É£ now initialize dashboard parts
  initDashboardUI(userData);
};

function renderDepositPanel() {
  document.getElementById("depositSection").innerHTML = `
    <div class="panel">
      <h3>üí≥ Deposit</h3>

      <label>Enter Amount (USD)</label>
      <input id="amt" type="number" min="20" placeholder="Minimum $20" />

      <div class="submit">
        <button class="btn secondary" id="submitDeposit">
          Submit Deposit
        </button>
      </div>

      <div id="submitMsg" class="mini"></div>
    </div>
  `;
}

function renderRankPanel(userData) {
  const ranks = computeRanks(userData);

  document.getElementById("rankSection").innerHTML = `
    <div class="rank-panel">

      <div class="rank-header">
        <div class="rank-header-title">üèÖ Your Rank & Levels</div>
        <div class="rank-current-label">
          Current: <b>${ranks.current}</b>
        </div>
      </div>

      <div class="rank-tabs">
        <button class="rank-tab ${ranks.isOrigin ? 'achieved' : 'locked'}" data-rank="origin">Origin</button>
        <button class="rank-tab ${ranks.isLifeChanger ? 'achieved' : 'locked'}" data-rank="life_changer">Life Changer</button>
        <button class="rank-tab ${ranks.isAdvisor ? 'achieved' : 'locked'}" data-rank="advisor">Advisor</button>
        <button class="rank-tab ${ranks.isVisionary ? 'achieved' : 'locked'}" data-rank="visionary">Visionary</button>
        <button class="rank-tab ${ranks.isCreator ? 'achieved' : 'locked'}" data-rank="creator">Creator</button>
      </div>

      <div id="rankDetails" class="rank-details"></div>
    </div>
  `;
}


function bindRankLogic(userData) {
  const details = document.getElementById("rankDetails");
  if (!details) return;

  document.querySelectorAll(".rank-tab").forEach(btn => {
    btn.addEventListener("click", () => {
      document.querySelectorAll(".rank-tab").forEach(b => b.classList.remove("active"));
      btn.classList.add("active");

      const rank = btn.dataset.rank;

      const info = {
        origin: `
          <b>Origin</b>
          <ul>
            <li>Activate by depositing $20</li>
            <li>Eligible for team rewards</li>
          </ul>
        `,
        life_changer: `
          <b>Life Changer</b>
          <ul>
            <li>$1000 total team business</li>
            <li>10 active Origins</li>
          </ul>
        `,
        advisor: `
          <b>Advisor</b>
          <ul>
            <li>$5000 total team business</li>
          </ul>
        `,
        visionary: `
          <b>Visionary</b>
          <ul>
            <li>$25,000 total team business</li>
          </ul>
        `,
        creator: `
          <b>Creator</b>
          <ul>
            <li>$100,000 total team business</li>
          </ul>
        `
      };

      details.innerHTML = info[rank] || "";
    });
  });
}


function bindDepositLogic() {
  const submitBtn = document.getElementById("submitDeposit");
  const amtInput  = document.getElementById("amt");
  const msgEl     = document.getElementById("submitMsg");

  if (!submitBtn || !amtInput || !msgEl) {
    console.warn("Deposit elements not ready");
    return;
  }

  // live validation
  amtInput.addEventListener("input", () => {
    const v = parseFloat(amtInput.value);
    if (isNaN(v) || v < 20) {
      submitBtn.disabled = true;
      msgEl.style.display = "block";
      msgEl.textContent = "Minimum deposit is $20";
    } else {
      submitBtn.disabled = false;
      msgEl.textContent = "";
    }
  });

  submitBtn.onclick = async () => {
    if (submitBtn.disabled) return;

    submitBtn.disabled = true;

    try {
      const amount = parseFloat(amtInput.value);
      if (isNaN(amount) || amount < 20) {
        throw new Error("Minimum deposit is $20");
      }

      msgEl.textContent = "Creating transaction‚Ä¶";

      const txHash = await sendTonDeposit(amount);

      msgEl.textContent = "Submitting deposit‚Ä¶";

      const res = await fetch(
        BACKEND_URL + "/debug/simulate_deposit",
        {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-DEBUG-KEY": "48549630436fd1cb439e62b62e888b6c"
          },
          body: JSON.stringify({
            user_id: window.currentUserData.id,
            amount: Number(amount.toFixed(2)),
            tx_musd: txHash
          })
        }
      );

      const data = await res.json();
      if (!data.ok) throw new Error(data.error || "Deposit failed");

      msgEl.textContent = "‚úÖ Deposit successful!";
      amtInput.value = "";

    } catch (err) {
      msgEl.textContent = err.message;
    }

    submitBtn.disabled = false;
  };

}

function initDashboardUI(userData) {
  // Avatar + name + id
  renderUserHeader(userData);

  // Deposit
  renderDepositPanel();
  bindDepositLogic();

  // Rank
  renderRankPanel(userData);
  bindRankLogic(userData);

  updateAdminMenuVisibility();
}

function getDashboardSkeletonHTML() {
  return `
    <div class="deposit-header">
      <button id="menuBtn" class="hamburger">‚ò∞</button>
      <div class="deposit-title">MSTC Dashboard</div>
    </div>

    <!-- USER HEADER -->
    <div id="userHeader"></div>

    <!-- DEPOSIT -->
    <div id="depositSection"></div>

    <!-- RANK -->
    <div id="rankSection"></div>
  `;
}
 
  // expose renderRegisteredView globally
  window.renderRegisteredView = renderRegisteredView;

  // --- Helper: show full view from backend (YES or auto for registered users) ---
   

  // --- Activation status (first screen, Yes/No) ---
  function updateActivationStatus(user) {
    const statusEl = document.getElementById("accountStatus");
    const registerSection = document.getElementById("registerSection");
    if (!user || !statusEl || !registerSection) return;

    if (!user.exists) {
      // FIRST TIME USER ‚Äì show question + Yes/No
      statusEl.textContent = "Do you want to register?";
      registerSection.style.display = "";
    } else {
      // REGISTERED USER ‚Äì hide question
      registerSection.style.display = "none";
      if (user.is_active) {
        statusEl.textContent = "You are activated as Origin ‚úÖ";
      } else {
        statusEl.textContent =
          "You are registered but not activated yet. Deposit at least $20 to activate Origin.";
      }
    }
  }

  const loadActivationStatus = async () => {
  const tgApp = tg;
  if (!tgApp) {
    console.error("Telegram WebApp not available");
    return null;   // ‚úÖ RETURN something
  }

  const initData = tgApp.initData || "";

  try {
    const res = await fetch(BACKEND_URL + '/webapp/init', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        initData,
        ref: window.currentRef || null
      })
    });

    const data = await res.json();
    console.log("VERIFY RESPONSE:", data);

    if (data && data.ok !== false) {
      updateActivationStatus(data);

      // ‚ùå IMPORTANT: do NOT auto-render dashboard here
      // We only return data and let caller decide
    } else {
      console.error("init failed", data);
    }

    return data;   // ‚úÖ ADD THIS LINE (MOST IMPORTANT)

  } catch (err) {
    console.error("Error loading activation status:", err);
    return null;   // ‚úÖ RETURN on error
  }
};

function showRegisterScreen() {
  const reg = document.getElementById("registerSection");
  if (reg) reg.style.display = "";
}

  // --- YES / NO button handlers + init ---
document.addEventListener("DOMContentLoaded", async () => {
  try {
    const data = await loadActivationStatus(); // calls /webapp/init

    if (data?.ok && data.exists === true) {
      // user already registered earlier
      renderRegisteredView(
        data.user.id,
        data.user.first_name,
        null,
        data.user
      );
      return;
    }

    // üëá NEW USER ‚Äî show YES / NO only
    showRegisterScreen();

  } catch (e) {
    console.error("Init failed", e);
    showRegisterScreen();
  }
});


  
// ================= MENU EVENT DELEGATION =================
function openMenu() {
  document.getElementById("sideMenu")?.classList.add("open");
  document.getElementById("menuOverlay")?.classList.add("show");
}

function closeMenu() {
  document.getElementById("sideMenu")?.classList.remove("open");
  document.getElementById("menuOverlay")?.classList.remove("show");
}

function openModal(title, html) {
  const modal = document.getElementById("modal");
  if (!modal) {
    console.error("Modal container not found");
    return;
  }
  document.getElementById("modalTitle").innerText = title;
  document.getElementById("modalBody").innerHTML = html;
  modal.classList.remove("hidden");
}

// Close modal when clicking outside modal-card
document.getElementById("modal")?.addEventListener("click", (e) => {
  if (e.target.id === "modal") {
    closeModal();
  }
});

  function closeModal() {
    document.getElementById("modal").classList.add("hidden");
  }

  async function openProfile() {
  const res = await fetch(BACKEND_URL + "/webapp/profile", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ initData: tg.initData })
  });

  const data = await res.json();
  if (!data.ok) return;

  const u = data.user;
  openModal("Profile", `
    <div><b>Name:</b> ${u.first_name}</div>
    <div><b>Username:</b> @${u.username || "N/A"}</div>
    <div><b>Role:</b> ${u.role}</div>
    <div><b>MSTC:</b> ${u.balance_mstc}</div>
    <div><b>MUSD:</b> ${u.balance_musd}</div>
  `);
}

async function openRole() {
  const res = await fetch(BACKEND_URL + "/webapp/role", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ initData: tg.initData })
  });

  const d = await res.json();
  if (!d.ok) return;

  openModal("Current Role", `
    <div><b>Role:</b> ${d.role}</div>
    <div>Active Origins: ${d.active_origin_count}</div>
    <div>Total Team Business: $${d.total_team_business}</div>
  `);
}

async function openDownlines() {
  const res = await fetch(BACKEND_URL + "/webapp/downlines", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ initData: tg.initData })
  });

  const d = await res.json();
  if (!d.ok) return;

  if (!d.downlines.length) {
    openModal("Downlines", "<div>No direct downlines yet</div>");
    return;
  }

  openModal("Downlines",
    d.downlines.map(u => `
      <div style="padding:6px;border-bottom:1px solid #333">
        ${u.first_name} (${u.role}) ‚Äî $${u.team_business}
      </div>
    `).join("")
  );
}

async function openAdminUsers() {
  try {
    openModal("Admin ‚Ä¢ Users", "<div class='mini'>Loading users‚Ä¶</div>");

    const res = await fetch(BACKEND_URL + "/admin/users", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ initData: tg.initData })
    });

    const data = await res.json();

    if (!data.ok) {
      openModal("Admin", "‚ùå Access denied");
      return;
    }

    const users = data.users || [];

    if (!users.length) {
      openModal("Admin ‚Ä¢ Users", "<div>No users found</div>");
      return;
    }

    // üîπ Build user rows
    const rowsHtml = users.map(u => {

  // üîí Prevent self-modification
  const isSelf = u.id === window.currentUserData?.id;

  return `
    <div class="admin-user-row"
         data-search="${(u.first_name || "").toLowerCase()}
                      ${(u.username || "").toLowerCase()}
                      ${u.id}">

      <b>${u.first_name || "User"}</b>
      <div class="mini">@${u.username || "‚Äî"}</div>

      <div class="mini">
        Role: <b>${u.role}</b> ${u.active ? "‚úÖ Active" : "‚ùå Inactive"}
      </div>

      <div class="mini">
        MUSD: ${u.balance_musd} | MSTC: ${u.balance_mstc}
      </div>

      <div class="mini">ID: ${u.id}</div>

      ${
        isSelf
          ? `<div class="mini" style="margin-top:8px;opacity:.7">
               ‚ö†Ô∏è You (cannot modify yourself)
             </div>`
          : `
            <div style="margin-top:8px; display:flex; gap:6px; flex-wrap:wrap">
              ${u.role !== "admin" ? `
                <button class="btn secondary"
                  onclick="adminUpdateUser(${u.id}, 'promote')">
                  üîº Promote
                </button>
              ` : `
                <button class="btn alt"
                  onclick="adminUpdateUser(${u.id}, 'demote')">
                  üîΩ Demote
                </button>
              `}

              ${u.active ? `
                <button class="btn alt"
                  onclick="adminUpdateUser(${u.id}, 'deactivate')">
                  ‚õî Deactivate
                </button>
              ` : `
                <button class="btn secondary"
                  onclick="adminUpdateUser(${u.id}, 'activate')">
                  ‚úÖ Activate
                </button>
              `}
            </div>
          `
      }

    </div>
  `;
}).join("");

    // üîπ Modal content
    openModal("Admin ‚Ä¢ Users", `
      <div style="margin-bottom:10px">
        <input
          id="adminUserSearch"
          type="text"
          placeholder="Search by name, username, ID‚Ä¶"
          style="
            width:100%;
            padding:10px;
            border-radius:8px;
            border:1px solid rgba(255,255,255,.2);
            background:rgba(255,255,255,.08);
            color:#fff;
          "
        />
      </div>

      <div id="adminUserList">
        ${rowsHtml}
      </div>

      <div style="margin-top:10px">
        <button class="btn secondary" onclick="closeModal()">‚¨Ö Back</button>
      </div>
    `);

    // ================= MENU WIRES =================
const menuBtn = document.getElementById("menuBtn");
const closeBtn = document.getElementById("closeMenu");
const overlay = document.getElementById("menuOverlay");

menuBtn && menuBtn.addEventListener("click", openMenu);
closeBtn && closeBtn.addEventListener("click", closeMenu);
overlay && overlay.addEventListener("click", closeMenu);

    // üîç Search logic
    const searchInput = document.getElementById("adminUserSearch");
    const rows = document.querySelectorAll(".admin-user-row");

    searchInput.addEventListener("input", () => {
      const q = searchInput.value.toLowerCase().trim();

      rows.forEach(row => {
        const hay = row.dataset.search;
        row.style.display = hay.includes(q) ? "" : "none";
      });
    });

  } catch (err) {
    console.error("openAdminUsers error", err);
    openModal("Admin Error", "‚ö†Ô∏è Failed to load users");
  }
}

async function adminUpdateUser(userId, action) {
  const confirmMsg = {
    promote: "Promote this user to ADMIN?",
    demote: "Demote this user to MEMBER?",
    activate: "Activate this user?",
    deactivate: "Deactivate this user?"
  }[action];

  if (!confirm(confirmMsg)) return;

  try {
    const res = await fetch(BACKEND_URL + "/admin/update_user", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        initData: tg.initData,
        user_id: userId,
        action
      })
    });

    const data = await res.json();

    if (!data.ok) {
      alert("Action failed");
      return;
    }

    // Refresh list
    openAdminUsers();

  } catch (err) {
    console.error("adminUpdateUser error", err);
    alert("Server error");
  }
}

async function adminImpersonate(userId) {
  if (!confirm("Impersonate this user?\nYou can exit anytime.")) return;

  const res = await fetch(BACKEND_URL + "/admin/impersonate", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      initData: tg.initData,
      user_id: userId
    })
  });

  const d = await res.json();
  if (!d.ok) {
    alert("Impersonation failed");
    return;
  }

  window.impersonation.active = true;
  window.impersonation.user = d.impersonated_user;

  closeModal();
 
  showImpersonationBanner();
}

function showImpersonationBanner() {
  if (!window.impersonation.active) return;

  const banner = document.createElement("div");
  banner.id = "impersonationBanner";
  banner.style.cssText = `
    position:fixed;
    bottom:0;
    left:0;
    right:0;
    background:#b71c1c;
    color:#fff;
    padding:10px;
    font-size:14px;
    z-index:3000;
    display:flex;
    justify-content:space-between;
    align-items:center;
  `;

  banner.innerHTML = `
    <span>üïµÔ∏è Impersonating user: ${window.impersonation.user.first_name}</span>
    <button onclick="stopImpersonation()"
      style="background:#fff;color:#000;border:0;padding:6px 10px;border-radius:6px">
      Exit
    </button>
  `;

  document.body.appendChild(banner);
}

function stopImpersonation() {
  window.impersonation.active = false;
  window.impersonation.user = null;

  document.getElementById("impersonationBanner")?.remove();
 
}

  async function openWallet() {
  const u = window.currentUserData || {};
  openModal("Wallet", `
    <div>MSTC Balance: ${u.balance_mstc || 0}</div>
    <div>MUSD Balance: ${u.balance_musd || 0}</div>
  `);
}

function openAdminStats() {
  openModal("Admin Stats", "Coming soon‚Ä¶");
}

function updateAdminMenuVisibility() {
  const adminMenu = document.getElementById("adminMenu");
  if (!adminMenu) return;

  const role = window.currentUserData?.role;
  if (role === "admin" || role === "superadmin") {
    adminMenu.style.display = "block";
  } else {
    adminMenu.style.display = "none";
  }
}

function logout() {
  Telegram.WebApp.close();
}

let REGISTER_RETRIES = 0;
const MAX_REGISTER_RETRIES = 6;

async function doRegister() {
  const yesBtn = document.getElementById("yesBtn");
  yesBtn.disabled = true;

  // 1Ô∏è‚É£ Get user info directly from Telegram (no backend)
  const tgUser = Telegram.WebApp.initDataUnsafe?.user;

  if (!tgUser) {
    alert("Telegram user not available");
    yesBtn.disabled = false;
    return;
  }

  // 2Ô∏è‚É£ OPEN DEPOSIT PANEL IMMEDIATELY
  renderRegisteredView(
    tgUser.id,
    tgUser.first_name,
    tgUser.photo_url || null,
    {
      id: tgUser.id,
      first_name: tgUser.first_name,
      username: tgUser.username,
      role: "member",
      self_activated: false,
      balance_musd: 0,
      balance_mstc: 0,
      total_team_business: 0,
      active_origin_count: 0
    }
  );

  function renderUserHeader(userData) {
  const tgUser = Telegram.WebApp?.initDataUnsafe?.user || {};

  const avatar =
    userData.photo_url ||
    tgUser.photo_url ||
    baseLogo;

  const name =
    userData.first_name ||
    tgUser.first_name ||
    "User";

  const username =
    userData.username ||
    tgUser.username ||
    null;

  const tgId =
    userData.id ||
    tgUser.id ||
    "";

  document.getElementById("userHeader").innerHTML = `
    <div class="user-header">
      <img src="${avatar}" class="logo glow" />

      <div class="row big">
        ${name}
        ${username ? `<span class="mini"> @${username}</span>` : ""}
      </div>

      <div class="row mini">
        Telegram ID: <span class="mono">${tgId}</span>
      </div>
    </div>
  `;
}

  // 3Ô∏è‚É£ Fire registration in background (DON‚ÄôT BLOCK UI)
  fetch("/webapp/register", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      initData: Telegram.WebApp.initData
    })
  }).catch(err => {
    console.warn("Registration deferred (DB warming)", err);
  });
}


let DASHBOARD_RETRIES = 0;
const MAX_DASHBOARD_RETRIES = 8;

async function loadDashboardAfterRegister() {
  console.log("üü¢ loadDashboardAfterRegister() START");

  try {
    const res = await fetch(BACKEND_URL + "/webapp/init", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        initData: Telegram.WebApp.initData,
        ref: window.currentRef || null
      })
    });

    // üü° DB still warming ‚Üí retry
    if (res.status === 503) {
      DASHBOARD_RETRIES++;

      if (DASHBOARD_RETRIES >= MAX_DASHBOARD_RETRIES) {
        alert("Server is still starting. Please reopen the app.");
        return;
      }

      console.warn("‚è≥ Dashboard DB warming, retrying...");
      setTimeout(loadDashboardAfterRegister, 3000);
      return;
    }

    const data = await res.json();
    console.log("üë§ /webapp/init JSON:", data);

    if (!data.ok || !data.user) {
      throw new Error("Invalid dashboard response");
    }

    DASHBOARD_RETRIES = 0;

    const u = data.user;
    const uid = u.id;
    const name =
      ((u.first_name || '') +
       (u.username ? ' @' + u.username : '')) || 'Unknown';
    const avatar = u.photo_url || './Botologo_new.png';

    renderRegisteredView(uid, name, avatar, u);

  } catch (e) {
    console.error("üî• Dashboard load error:", e);
    setTimeout(loadDashboardAfterRegister, 3000);
  }
}

document.addEventListener("click", (e) => {

    if (e.target.id === "menuBtn") {
        openMenu();
    }

    if (e.target.id === "closeMenu") {
        closeMenu();
    }

    if (e.target.id === "menuOverlay") {
        closeMenu();
    }

});

</script> 
<!-- üîπ Side Menu -->
<div id="sideMenu" class="side-menu">
  <div class="menu-header">
    <span>Menu</span>
    <button id="closeMenu">‚úï</button>
  </div>

  <div class="menu-content">
    <div class="menu-item" onclick="openProfile()">üë§ Profile</div>
    <div class="menu-item" onclick="openRole()">‚≠ê Current Role</div>
    <div class="menu-item" onclick="openDownlines()">üå≥ Downlines</div>
    <div class="menu-item" onclick="openWallet()">üíº Wallet</div>

    <!-- ADMIN MENU (hidden by default) -->
  <div id="adminMenu" style="display:none;">
    <div class="menu-divider">Admin</div>
    <div class="menu-item admin" onclick="openAdminUsers()">üë• All Users</div>
    <div class="menu-item admin" onclick="openAdminStats()">üìä System Stats</div>
  </div>

    <div class="menu-item logout" onclick="logout()">üö™ Logout</div>
  </div>
</div>

 <!-- üîπ Overlay Menu -->
<div id="menuOverlay" class="menu-overlay"></div>
      
</body>
</html>


