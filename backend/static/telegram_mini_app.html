<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MSTC Earning Project ‚Äî Deposit & Reward System</title>

  <!-- Telegram Web App JS -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <!-- TON Connect UI -->
  <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>

  <style>
    * { box-sizing: border-box; }

    body {
      margin: 0;
      min-height: 100vh;
      display: block;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
      text-align: center;
      color: #fff;
      background:
        radial-gradient(1200px 600px at 50% -20%, rgba(255,255,255,.08), transparent 60%),
        linear-gradient(135deg, #5c3cff, #0e1630 60%);
      overflow-y: auto;
      overflow-x: hidden;
      padding: 12px 10px 24px;
    }

    .card {
      width: min(720px, 96vw);
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.15);
      border-radius: 20px;
      padding: 22px;
      box-shadow: 0 18px 50px rgba(0,0,0,.25);
      backdrop-filter: blur(6px);
      margin: 8px auto 24px;
    }

    .logo {
      width:88px;
      height:88px;
      border-radius:50%;
      object-fit:cover;
      border:4px solid rgba(255,255,255,.35);
      margin:0 auto 14px;
      display:block;
      box-shadow: 0 10px 26px rgba(0,0,0,.35), 0 0 0 8px rgba(255,255,255,.08) inset;
      position:relative;
    }
    .logo.glow { border-color:transparent; box-shadow:none; isolation:isolate; }
    .logo.glow::before, .logo.glow::after {
      content:"";
      position:absolute;
      inset:-6px;
      border-radius:50%;
      z-index:-1;
    }
    .logo.glow::before {
      background: conic-gradient(from 0deg,#6cf 0%,#8af 25%,#9ff 50%,#7df 75%,#6cf 100%);
      filter: blur(6px);
      animation: spin 4s linear infinite;
      opacity:.95;
    }
    .logo.glow::after {
      inset:-14px;
      background: radial-gradient(closest-side, rgba(108,240,255,.5), rgba(0,0,0,0));
      filter: blur(10px);
      opacity:.65;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    h2 { margin:0 0 10px; font-weight:700; }
    .row { margin:10px 0; font-size:1.05rem; }
    .big { font-size:1.25rem; font-weight:700; }
    .actions { margin-top:16px; display:flex; gap:12px; justify-content:center; }
    .btn {
      padding:11px 22px;
      border-radius:22px;
      border:0;
      cursor:pointer;
      font-weight:600;
      background:#00c853;
      color:#fff;
      box-shadow:0 8px 24px rgba(0,200,83,.35);
    }
    .btn.alt { background:#e53935; box-shadow:0 8px 24px rgba(229,57,53,.35); }
    .btn.secondary { background:#2a7de1; box-shadow:0 8px 24px rgba(42,125,225,.35); }

    .ref-line {
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      margin-top:8px;
    }
    .copy-btn {
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width:36px;
      height:36px;
      border-radius:10px;
      border:none;
      cursor:pointer;
      background:rgba(255,255,255,.16);
      color:#fff;
      font-size:18px;
      transition: transform .12s ease, opacity .2s;
    }
    .copy-btn:active { transform: scale(.96); }

    .tooltip { margin-top:8px; font-size:.85rem; opacity:0; transition: opacity .25s; }
    .show { opacity:1; }

    .panel {
      margin-top:18px;
      text-align:left;
      background:rgba(0,0,0,.18);
      padding:16px;
      border-radius:14px;
    }
    .panel h3 { margin:0 0 10px; color:#fff; }

    label {
      display:block;
      font-size:.95rem;
      opacity:.9;
      margin:10px 0 6px;
    }
    input, .addr-box {
      width:100%;
      padding:12px 12px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(255,255,255,.08);
      color:#fff;
      outline:none;
    }

    .split {
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:12px;
      margin-top:12px;
    }
    .rowline { display:flex; align-items:center; gap:10px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; word-break:break-all; }
    .mini { font-size:.9rem; opacity:.9; }
    .submit { margin-top:14px; text-align:right; }
    .error { color:#ffb4b4; font-size:.9rem; margin-top:6px; }
    .ok { color:#b5ffcb; font-size:.9rem; margin-top:6px; }

    .rank-panel {
      margin-top:18px;
      background:rgba(0,0,0,.18);
      padding:16px;
      border-radius:14px;
    }
    .rank-header {
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:8px;
    }
    .rank-header-title { font-size:1rem; font-weight:600; }
    .rank-tabs {
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-bottom:10px;
    }
    .rank-tab {
      width:100%;
      padding:12px 14px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(255,255,255,.06);
      color:#fff;
      font-size:.85rem;
      cursor:pointer;
      display:flex;
      flex-direction:column;
      align-items:center;
      text-align:center;
      gap:6px;
      position:relative;
      overflow:hidden;
    }
    .rank-name { font-weight:600; font-size:.9rem; }
    .rank-percent { font-size:.8rem; opacity:.9; }
    .rank-status { font-size:.75rem; opacity:.85; }
    .rank-tab.achieved {
      border-color:#00c853;
      box-shadow: 0 0 0 1px rgba(0,200,83,.4), 0 0 16px rgba(0,200,83,.45);
    }
    .rank-tab.achieved::before {
      content:"";
      position:absolute;
      left:0; top:0; bottom:0;
      width:5px;
      background: linear-gradient(180deg, rgba(0,200,83,1), rgba(0,200,83,0.1));
    }
    .rank-details { font-size:.9rem; line-height:1.4; }
  </style>
</head>
<body>
  <div class="card" id="app">
    <img src="./Botologo_new.png" alt="MSTC EARNING PROJECT" class="logo" id="avatar" />

    <!-- Registration question + Yes/No; hidden later for registered users -->
    <div id="registerSection">
      <h2 id="accountStatus">Do you want to register?</h2>
      <div class="actions">
        <button id="yesBtn" class="btn" type="button">Yes</button>
        <button id="noBtn" class="btn alt" type="button">No</button>
      </div>
    </div>
  </div>

<script>
/* ----------------------
   CONFIG
   ---------------------- */
const API_BASE   = 'https://mstcbotnew-production.up.railway.app';

// Global TON Connect UI instance
let tonConnectUI = null;
try {
  if (window.TON_CONNECT_UI) {
    tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
      manifestUrl: API_BASE + '/static/tonconnect-manifest.json'
    });
    console.log('TON Connect UI initialized');
  } else {
    console.warn('TON_CONNECT_UI is not available on window');
  }
} catch (e) {
  console.warn('TON Connect init failed', e);
}

// Use /webapp/init for activation / registration status (it expects initData)
const API_VERIFY  = API_BASE + '/webapp/init';
// Use /webapp/verify for deposits (it expects initData + amount)
const API_DEPOSIT = API_BASE + '/webapp/verify';

const ADDR_MUSD   = "0x7e6916Af95714BE309cF3eee98149074921D93e0";
const ADDR_MSTC   = "0x7e6916Af95714BE309cF3eee98149074921D93e0";
const CHAIN_LABEL = "EVM Chain";
const MIN_DEPOSIT = 20.00;

/* ----------------------
   Helpers
   ---------------------- */
const app = document.getElementById('app');
const baseLogo = './Botologo_new.png';

function copyText(txt, tipEl) {
  navigator.clipboard.writeText(String(txt)).then(() => {
    if (tipEl) {
      tipEl.classList.add('show');
      setTimeout(() => tipEl.classList.remove('show'), 1200);
    }
  }).catch(() => alert('Copy failed'));
}

function fmt(n) {
  return Number(n || 0).toFixed(2);
}

/* ----------------------
   Referral from URL
   ---------------------- */
const urlParams = new URLSearchParams(window.location.search);
let ref = urlParams.get("ref") || null;
window.currentRef = ref;

/* ----------------------
   Telegram WebApp object
   ---------------------- */
const tg = (window.Telegram && window.Telegram.WebApp) ? window.Telegram.WebApp : null;
try {
  if (tg && typeof tg.ready === 'function') tg.ready();
  if (tg && typeof tg.expand === 'function') tg.expand();
} catch (e) {
  console.warn('tg.ready/expand error', e);
}

/* ----------------------
   VERIFY / LOAD user from backend
   ---------------------- */
async function verifyInitData() {
  const initData = tg ? (tg.initData || '') : '';
  const unsafe = tg && tg.initDataUnsafe ? tg.initDataUnsafe : null;
  const unsafeUser = unsafe && unsafe.user ? unsafe.user : null;

  const startParam = (unsafe && (unsafe.start_param || unsafe.startParam))
    ? (unsafe.start_param || unsafe.startParam)
    : null;

  if (!window.currentRef && startParam) {
    window.currentRef = startParam;
    ref = startParam;
  }

  const payload = { initData, ref: window.currentRef || null };

  try {
    console.debug('POST', API_VERIFY, payload);
    const res = await fetch(API_VERIFY, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    const j = await res.json().catch(() => ({}));
    if (!res.ok || j.ok === false) {
      console.warn('verify failed server response', res.status, j);
      return { ok: false, user: j.user || unsafeUser || {} , raw: j };
    }

    if (j.user) {
      return { ok: true, user: j.user, raw: j };
    } else {
      const userFields = Object.assign({}, j);
      delete userFields.ok;
      return { ok: true, user: userFields, raw: j };
    }
  } catch (err) {
    console.warn('verify error ‚Äî network or parse', err);
    return { ok: false, user: unsafeUser || {}, error: err && err.message };
  }
}

/* ----------------------
   Ranks
   ---------------------- */
function computeRanks(user) {
  const total = Number(user.total_team_business || 0);
  const activeOrigins = Number(user.active_origin_count || 0);
  const role = (user.role || '').toLowerCase();
  const selfActivated = !!user.self_activated;

  const isOrigin     = selfActivated || role === 'origin';
  const isLifeChanger= total >= 1000 && activeOrigins >= 10;
  const isAdvisor    = total >= 5000;
  const isVisionary  = total >= 25000;
  const isCreator    = total >= 100000;

  let current = 'Member';
  if (isCreator)      current = 'Creator';
  else if (isVisionary) current = 'Visionary';
  else if (isAdvisor)   current = 'Advisor';
  else if (isLifeChanger) current = 'Life Changer';
  else if (isOrigin)     current = 'Origin';

  return { isOrigin, isLifeChanger, isAdvisor, isVisionary, isCreator, total, activeOrigins, current };
}

/* ----------------------
   Registered view
   ---------------------- */
function renderRegisteredView(uid, name, avatar, userData) {
  const ranks = computeRanks(userData || {});
  const total = (ranks.total || 0).toFixed(2);
  const activeOrigins = ranks.activeOrigins || 0;
  const originProgress = ranks.isOrigin ? 100 : 0;
  const lcBusiness = Math.min(ranks.total / 1000, 1);
  const lcOrigins = Math.min(ranks.activeOrigins / 10, 1);
  const lifeChangerProgress = ranks.isLifeChanger ? 100 : Math.round(Math.min((lcBusiness + lcOrigins) / 2, 1) * 100);
  const advisorProgress = ranks.isAdvisor ? 100 : Math.round(Math.min(ranks.total / 5000, 1) * 100);
  const visionaryProgress = ranks.isVisionary ? 100 : Math.round(Math.min(ranks.total / 25000, 1) * 100);
  const creatorProgress = ranks.isCreator ? 100 : Math.round(Math.min(ranks.total / 100000, 1) * 100);

  const refLink = `https://t.me/mstcrefbot?start=${uid}`;

  app.innerHTML = `
      <img src="${avatar || baseLogo}" class="logo glow" />
      <div class="row big">${uid ?? '(unknown)'}</div>
      <div class="row">${(name || 'Unknown')}</div>
      <div class="row mini">Current: <b>${ranks.current}</b></div>
      <!-- <div class="row mini">Total Team Business: <b>$${total}</b> ¬∑ Active Origins: <b>${activeOrigins}</b></div> -->

      <div class="row ref-line">
        <span class="mini">Referral Link</span>
        <button class="copy-btn" id="copyRef">üìã</button>
      </div>
      <div class="tooltip" id="tipRef">Copied!</div>

      <div class="panel">
        <h3>üîó TON Wallet</h3>
        <!-- <div id="walletStatus" class="mini">Not connected</div> -->
        <button class="btn secondary" id="connectWalletBtn" type="button">Connect TON Wallet</button>
        <div id="walletAddress" class="mini mono" style="margin-top:6px;"></div>
      </div>

      <div class="panel">
        <h3>üí≥ Deposit</h3>
        <div class="mini">Minimum deposit ‚Äî <b>$${MIN_DEPOSIT}</b>.</div>

        <label>Enter USD amount</label>
        <input id="amt" type="number" min="${MIN_DEPOSIT}" step="0.01" placeholder="e.g., 20.00" />
        <div id="err" class="error" style="display:none;"></div>

        <div class="split">
          <div>
            <div class="mini">MUSD (70%)</div>
            <div class="rowline">
              <span id="musdAmt" class="big">0.00</span>
              <span class="mini">USD</span>
            </div>

            <label class="mini" style="margin-top:8px;">Send to (MUSD address)</label>
            <div class="addr-box mono">${ADDR_MUSD}</div>
            <div class="rowline" style="margin-top:6px;">
              <button class="copy-btn" id="copyMUSD">üìã</button>
              <span class="mini">${CHAIN_LABEL}</span>
            </div>

            <label class="mini" style="margin-top:8px;">MUSD Tx Hash</label>
            <input id="txMUSD" type="text" placeholder="Paste transaction hash" />
          </div>

          <div>
            <div class="mini">MSTC (30%)</div>
            <div class="rowline">
              <span id="mstcAmt" class="big">0.00</span>
              <span class="mini">USD</span>
            </div>

            <label class="mini" style="margin-top:8px;">Send to (MSTC address)</label>
            <div class="addr-box mono">${ADDR_MSTC}</div>
            <div class="rowline" style="margin-top:6px;">
              <button class="copy-btn" id="copyMSTC">üìã</button>
              <span class="mini">${CHAIN_LABEL}</span>
            </div>

            <label class="mini" style="margin-top:8px;">MSTC Tx Hash</label>
            <input id="txMSTC" type="text" placeholder="Paste transaction hash" />
          </div>
        </div>

        <div class="submit">
          <button class="btn secondary" id="submitDeposit">Submit Deposit</button>
        </div>
        <div id="submitMsg" class="ok" style="display:none;"></div>
      </div>

      <div class="rank-panel">
        <div class="rank-header">
          <div class="rank-header-title">üèÖ Your Rank & Levels</div>
          <div class="rank-current-label">Current: <b>${ranks.current}</b></div>
          <!-- <div class="row mini">Current: <b>${ranks.current}</b></div> -->
        </div>

        <div class="rank-tabs">
          <button class="rank-tab ${ranks.isOrigin ? 'achieved' : 'locked'}" data-rank="origin">
            <div class="rank-main">
              <span class="rank-name">Origin</span>
              <span class="rank-percent">5% Level Income</span>
              <span class="rank-status">${ranks.isOrigin ? 'Achieved' : 'Locked'}</span>
            </div>
            <div class="rank-progress"><div class="rank-progress-bar" style="width:${originProgress}%;"></div></div>
            <div class="rank-progress-text">${originProgress}% ${originProgress === 100 ? 'achieved' : 'to unlock'}</div>
          </button>

          <button class="rank-tab ${ranks.isLifeChanger ? 'achieved' : 'locked'}" data-rank="life_changer">
            <div class="rank-main">
              <span class="rank-name">Life Changer</span>
              <span class="rank-percent">10% Direct</span>
              <span class="rank-status">${ranks.isLifeChanger ? 'Achieved' : 'Locked'}</span>
            </div>
            <div class="rank-progress"><div class="rank-progress-bar" style="width:${lifeChangerProgress}%;"></div></div>
            <div class="rank-progress-text">${lifeChangerProgress}% ${lifeChangerProgress === 100 ? 'achieved' : 'towards next rank'}</div>
          </button>

          <button class="rank-tab ${ranks.isAdvisor ? 'achieved' : 'locked'}" data-rank="advisor">
            <div class="rank-main">
              <span class="rank-name">Advisor</span>
              <span class="rank-percent">15% Club Rank</span>
              <span class="rank-status">${ranks.isAdvisor ? 'Achieved' : 'Locked'}</span>
            </div>
            <div class="rank-progress"><div class="rank-progress-bar" style="width:${advisorProgress}%;"></div></div>
            <div class="rank-progress-text">${advisorProgress}% ${advisorProgress === 100 ? 'achieved' : 'towards next rank'}</div>
          </button>

          <button class="rank-tab ${ranks.isVisionary ? 'achieved' : 'locked'}" data-rank="visionary">
            <div class="rank-main">
              <span class="rank-name">Visionary</span>
              <span class="rank-percent">20% Club Rank</span>
              <span class="rank-status">${ranks.isVisionary ? 'Achieved' : 'Locked'}</span>
            </div>
            <div class="rank-progress"><div class="rank-progress-bar" style="width:${visionaryProgress}%;"></div></div>
            <div class="rank-progress-text">${visionaryProgress}% ${visionaryProgress === 100 ? 'achieved' : 'towards next rank'}</div>
          </button>

          <button class="rank-tab ${ranks.isCreator ? 'achieved' : 'locked'}" data-rank="creator">
            <div class="rank-main">
              <span class="rank-name">Creator</span>
              <span class="rank-percent">25% Top Rank</span>
              <span class="rank-status">${ranks.isCreator ? 'Achieved' : 'Locked'}</span>
            </div>
            <div class="rank-progress"><div class="rank-progress-bar" style="width:${creatorProgress}%;"></div></div>
            <div class="rank-progress-text">${creatorProgress}% ${creatorProgress === 100 ? 'achieved' : 'towards top rank'}</div>
          </button>
        </div>

        <div id="rankDetails" class="rank-details"></div>
      </div>
  `;

  // --- Wire events ---

  const tip = document.getElementById('tipRef');
  const copyRefBtn = document.getElementById('copyRef');
  if (copyRefBtn && tip) copyRefBtn.onclick = () => copyText(refLink, tip);

  const amtInput    = document.getElementById('amt');
  const musdAmt     = document.getElementById('musdAmt');
  const mstcAmt     = document.getElementById('mstcAmt');
  const errEl       = document.getElementById('err');
  const txMUSDInput = document.getElementById('txMUSD');
  const txMSTCInput = document.getElementById('txMSTC');
  const submitBtn   = document.getElementById('submitDeposit');
  const msgEl       = document.getElementById('submitMsg');
  const copyMUSDBtn = document.getElementById('copyMUSD');
  const copyMSTCBtn = document.getElementById('copyMSTC');

  if (amtInput && musdAmt && mstcAmt && errEl) {
    amtInput.oninput = () => {
      const v = parseFloat(amtInput.value || '0');
      if (isNaN(v) || v <= 0) {
        musdAmt.textContent = '0.00';
        mstcAmt.textContent = '0.00';
        errEl.style.display = 'none';
        errEl.textContent = '';
        return;
      }
      musdAmt.textContent = fmt(v * 0.70);
      mstcAmt.textContent = fmt(v * 0.30);

      if (v < MIN_DEPOSIT) {
        errEl.style.display = 'block';
        errEl.textContent = 'Minimum deposit is $' + MIN_DEPOSIT + '.';
      } else {
        errEl.style.display = 'none';
        errEl.textContent = '';
      }
    };
  }

  if (copyMUSDBtn && tip) copyMUSDBtn.onclick = () => copyText(ADDR_MUSD, tip);
  if (copyMSTCBtn && tip) copyMSTCBtn.onclick = () => copyText(ADDR_MSTC, tip);

  if (submitBtn) {
    submitBtn.onclick = async () => {
      if (errEl) { errEl.style.display = 'none'; errEl.textContent = ''; }
      if (msgEl) { msgEl.style.display = 'none'; msgEl.textContent = ''; }

      const valueStr = amtInput ? (amtInput.value ? amtInput.value.trim() : "0") : "0";
      const amount   = parseFloat(valueStr || "0");
      const tx1      = txMUSDInput ? txMUSDInput.value.trim() : "";
      const tx2      = txMSTCInput ? txMSTCInput.value.trim() : "";

      if (isNaN(amount) || amount < MIN_DEPOSIT) {
        if (errEl) {
          errEl.style.display = 'block';
          errEl.textContent = 'Please enter at least $' + MIN_DEPOSIT + '.';
        }
        if (tg && typeof tg.showAlert === 'function') {
          tg.showAlert('Please enter at least $' + MIN_DEPOSIT + '.');
        }
        return;
      }

      if (!tx1 || !tx2) {
        if (errEl) {
          errEl.style.display = 'block';
          errEl.textContent = 'Please paste both transaction hashes.';
        }
        if (tg && typeof tg.showAlert === 'function') {
          tg.showAlert('Please paste both transaction hashes.');
        }
        return;
      }

      const payload = {
        initData: tg ? (tg.initData || "") : "",
        amount: Number(amount.toFixed(2)),
        tx_musd: tx1,
        tx_mstc: tx2,
        ref: window.currentRef || null
      };

      if (msgEl) {
        msgEl.style.display = 'block';
        msgEl.textContent = 'Submitting...';
      }

      try {
        const res  = await fetch(API_DEPOSIT, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const data = await res.json().catch(() => ({}));
        console.debug('DEPOSIT RESPONSE:', data);

        if (data && data.ok) {
          let summaryLines = [];
          if (Array.isArray(data.referral_dist) && data.referral_dist.length > 0) {
            summaryLines.push("Referral distribution:");
            data.referral_dist.forEach(r => {
              const level = (r.level === 0 || r.level == null) ? "Pool" : `Level ${r.level}`;
              const who   = r.to_username || (r.to_user_id != null ? r.to_user_id : "company_pool");
              summaryLines.push(`${level}: ${who} ‚Üí $${r.amount}`);
            });
          } else if (data.referral_dist && typeof data.referral_dist === 'object' && data.referral_dist.amount) {
            summaryLines.push(`Referral: ${data.referral_dist.to || 'company_pool'} ‚Üí $${data.referral_dist.amount}`);
          } else {
            summaryLines.push("No referral distribution (no uplines linked).");
          }

          const summaryText = summaryLines.join("\n");

          if (tg && typeof tg.showAlert === 'function') {
            tg.showAlert("Deposit submitted successfully!\n\n" + summaryText);
          }

          if (msgEl) {
            msgEl.style.display = 'block';
            msgEl.innerHTML = "Deposit submitted successfully!<br><pre style='text-align:left; white-space:pre-wrap; margin-top:4px;'>" +
              summaryText + "</pre>";
          }

          await showRegisteredViewFromBackend();

          if (amtInput) amtInput.value = "";
          if (txMUSDInput) txMUSDInput.value = "";
          if (txMSTCInput) txMSTCInput.value = "";
          if (musdAmt) musdAmt.textContent = "0.00";
          if (mstcAmt) mstcAmt.textContent = "0.00";
        } else {
          const errText = data && (data.message || data.error || data.detail)
            ? (data.message || data.error || data.detail)
            : 'Unknown error';

          if (tg && typeof tg.showAlert === 'function') {
            tg.showAlert('Failed to submit: ' + errText);
          }
          if (msgEl) {
            msgEl.style.display = 'block';
            msgEl.textContent = 'Failed to submit: ' + errText;
          }
        }
      } catch (e) {
        const msg = e && e.message ? e.message : String(e);
        if (tg && typeof tg.showAlert === 'function') {
          tg.showAlert('Failed to submit: ' + msg);
        }
        if (msgEl) {
          msgEl.style.display = 'block';
          msgEl.textContent = 'Failed to submit: ' + msg;
        }
      }
    };
  }

  // --- TON Wallet connect wiring ---
  const walletStatusEl    = document.getElementById('walletStatus');
  const walletAddrEl      = document.getElementById('walletAddress');
  const connectWalletBtn  = document.getElementById('connectWalletBtn');

  if (connectWalletBtn) {
    // If already connected in this session, reflect it
    if (tonConnectUI && tonConnectUI.account && tonConnectUI.account.address) {
      const addr = tonConnectUI.account.address;
      if (walletStatusEl) walletStatusEl.textContent = 'Wallet connected ‚úÖ';
      if (walletAddrEl) walletAddrEl.textContent   = addr;
    }

    connectWalletBtn.onclick = async () => {
      // If TON isn‚Äôt available at all, tell the user instead of doing nothing
      if (!tonConnectUI) {
        if (walletStatusEl) {
          walletStatusEl.textContent = 'TON Connect not available (script or manifest error).';
        }
        if (tg && tg.showAlert) {
          tg.showAlert('TON Wallet connect is not available. Please check TON script / manifest.');
        }
        return;
      }

      try {
        // If already connected, just show existing address
        if (tonConnectUI.account && tonConnectUI.account.address) {
          const addrExisting = tonConnectUI.account.address;
          if (walletStatusEl) walletStatusEl.textContent = 'Wallet connected ‚úÖ';
          if (walletAddrEl)   walletAddrEl.textContent   = addrExisting;
          return;
        }

        // open wallet selector / connect flow
        await tonConnectUI.connectWallet();
        const account = tonConnectUI.account;
        const addr    = account && account.address ? account.address : null;

        if (!addr) {
          if (walletStatusEl) walletStatusEl.textContent = 'Failed to get wallet address';
          return;
        }

        if (walletStatusEl) walletStatusEl.textContent = 'Wallet connected ‚úÖ';
        if (walletAddrEl)   walletAddrEl.textContent   = addr;

        // get Telegram user id
        const tgUserId = tg && tg.initDataUnsafe && tg.initDataUnsafe.user && tg.initDataUnsafe.user.id;

        if (tgUserId) {
          const resp = await fetch(API_BASE + '/webapp/save_wallet', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              telegram_id: tgUserId,
              wallet_address: addr
            })
          });

          const j = await resp.json().catch(() => ({}));
          if (!resp.ok || !j.ok) {
            const m = (j.message || j.error || resp.status);
            if (walletStatusEl) {
              walletStatusEl.textContent = 'Wallet saved locally, but server error: ' + m;
            }
            if (tg && tg.showAlert) {
              tg.showAlert('Wallet connected, but failed to save on server: ' + m);
            }
          } else {
            if (walletStatusEl) walletStatusEl.textContent = 'Wallet connected & saved ‚úÖ';
          }
        } else {
          if (walletStatusEl) walletStatusEl.textContent = 'Wallet connected. Telegram user ID not found.';
        }
      } catch (e) {
        console.error('TON connect error', e);
        if (walletStatusEl) walletStatusEl.textContent = 'Wallet connect cancelled or failed.';
        if (tg && tg.showAlert) {
          tg.showAlert('TON wallet connect failed: ' + (e.message || String(e)));
        }
      }
    };
  }

  // Rank details wiring
  const rankDetailsHandler = () => {
    const rankDetails = document.getElementById('rankDetails');
    const rankTabs    = app.querySelectorAll('.rank-tab');

    function setActiveRankTab(rankKey) {
      rankTabs.forEach(btn => btn.classList.toggle('active', btn.dataset.rank === rankKey));
      let html = '';
      if (rankKey === 'origin') {
        html = `<b>Origin ‚Äì 5% Level Income</b><ul><li>Self activation required (your own qualifying deposit).</li><li>You start earning 5% from your direct team as Origin.</li></ul>`;
      } else if (rankKey === 'life_changer') {
        html = `<b>Life Changer ‚Äì 10% Direct</b><ul><li>1000 MUSD total team business.</li><li>10 active Origins in your group.</li></ul>`;
      } else if (rankKey === 'advisor') {
        html = `<b>Advisor ‚Äì 15%</b><ul><li>5000 MUSD total team business (target).</li></ul>`;
      } else if (rankKey === 'visionary') {
        html = `<b>Visionary ‚Äì 20%</b><ul><li>25000 MUSD total team business (target).</li></ul>`;
      } else if (rankKey === 'creator') {
        html = `<b>Creator ‚Äì 25%</b><ul><li>100000 MUSD total team business (top rank target).</li></ul>`;
      }
      if (rankDetails) rankDetails.innerHTML = html;
    }

    const tabs = app.querySelectorAll('.rank-tab');
    tabs.forEach(t => t.addEventListener('click', () => setActiveRankTab(t.dataset.rank)));

    const defaultTab = app.querySelector('.rank-tab.achieved')
      ? app.querySelector('.rank-tab.achieved').dataset.rank
      : 'origin';
    setActiveRankTab(defaultTab);
  };

  setTimeout(rankDetailsHandler, 100);
} // end renderRegisteredView

/* ----------------------
   Show full view (verify -> render)
   ---------------------- */
async function showRegisteredViewFromBackend() {
  const verifyResp = await verifyInitData();
  const unsafeUser = tg && tg.initDataUnsafe && tg.initDataUnsafe.user ? tg.initDataUnsafe.user : {};

  const u       = (verifyResp && verifyResp.user) ? verifyResp.user : unsafeUser || {};
  const id      = u.id || (u.user_id || 0);
  const name    = ((u.first_name || '') + (u.username ? ' @' + u.username : '')) || u.username || 'Unknown';
  const avatar  = u.photo_url || u.photo || baseLogo;
  const userObj = verifyResp.user || u || {};

  renderRegisteredView(id, name, avatar, userObj);
}

/* ----------------------
   Activation status (first screen)
   ---------------------- */
async function updateActivationStatus(user) {
  const statusEl        = document.getElementById("accountStatus");
  const registerSection = document.getElementById("registerSection");
  if (!statusEl || !registerSection) return;

  const hasReg = user && (user.has_registered === true || user.exists === true || user.registered === true || user.user_id);
  const isActive = user && (user.is_active === true || user.role === 'origin'
                 || user.self_activated === 1 || user.self_activated === true);

  if (!hasReg) {
    statusEl.textContent = "Do you want to register?";
    registerSection.style.display = "";
  } else {
    registerSection.style.display = "none";
    if (isActive) {
      statusEl.textContent = "You are activated as Origin ‚úÖ";
    } else {
      statusEl.textContent = "You are registered but not activated yet. Deposit at least $" + MIN_DEPOSIT + " to activate Origin.";
    }
  }
}

async function loadActivationStatus() {
  const resp = await verifyInitData();
  const user = resp && resp.user ? resp.user : {};
  updateActivationStatus(user);

  const hasReg = user && (user.has_registered === true || user.exists === true || user.registered === true || user.user_id);
  if (hasReg) {
    await showRegisteredViewFromBackend();
  } else {
    console.debug('User not registered or server returned no registration; showing register question.');
  }
}

/* ----------------------
   Boot
   ---------------------- */
document.addEventListener('DOMContentLoaded', () => {
  loadActivationStatus().catch(e => console.warn('loadActivationStatus error', e));

  const yesBtn = document.getElementById('yesBtn');
  const noBtn  = document.getElementById('noBtn');

  if (yesBtn) {
    yesBtn.onclick = async () => {
      await showRegisteredViewFromBackend();
    };
  }

  if (noBtn) {
    noBtn.onclick = () => {
      app.innerHTML = `<img src="${baseLogo}" class="logo" /><div class="row big">‚ùå Registration Cancelled</div>`;
    };
  }
});
</script>
</body>
</html>
