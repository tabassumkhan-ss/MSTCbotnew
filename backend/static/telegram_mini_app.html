<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MSTC Earning Project â€” Deposit & Reward System</title>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>

  <style>
   /** ğŸ”¥ Your existing CSS is unchanged completely **/
  </style>
</head>

<body>

<!-- MAIN CARD -->
<div class="card" id="app">
  <img src="./Botologo_new.png" class="logo" id="avatar" />

  <div id="registerSection">
    <h2 id="accountStatus">Do you want to register?</h2>

    <div class="actions">
      <button id="yesBtn" class="btn" onclick="doRegister()">Yes</button>
      <button id="noBtn" class="btn alt" type="button">No</button>
    </div>
  </div>
</div>

<!-- MODAL -->
<div id="modal" class="modal hidden">
 <div class="modal-card">
  <div class="modal-header">
    <span id="modalTitle"></span>
    <button onclick="closeModal()">âœ•</button>
  </div>
  <div id="modalBody" class="modal-body"></div>
 </div>
</div>

<div id="sideMenu" class="side-menu">
  <div class="menu-header">
    <span>Menu</span>
    <button id="closeMenu">âœ•</button>
  </div>

  <div class="menu-content">

    <div class="menu-item" onclick="openProfile()">ğŸ‘¤ Profile</div>
    <div class="menu-item" onclick="openRole()">â­ Current Role</div>
    <div class="menu-item" onclick="openDownlines()">ğŸŒ³ Downlines</div>
    <div class="menu-item" onclick="openWallet()">ğŸ’¼ Wallet</div>

    <div id="adminMenu" style="display:none;">
      <div class="menu-divider">Admin</div>
      <div class="menu-item admin" onclick="openAdminUsers()">ğŸ‘¥ All Users</div>
      <div class="menu-item admin" onclick="openAdminStats()">ğŸ“Š System Stats</div>
    </div>

    <div class="menu-item logout" onclick="logout()">ğŸšª Logout</div>

  </div>
</div>

<div id="menuOverlay" class="menu-overlay"></div>

<script>

const BACKEND_URL = "https://mstcbotnew-production.up.railway.app";
console.log("Using backend:", BACKEND_URL);

const tg = Telegram.WebApp;
tg.ready();
tg.expand();

window.currentRef = null;
window.currentUserData = null;

/* ===========================================================
   TON CONNECT INITIALIZATION
=========================================================== */

const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
  manifestUrl: BACKEND_URL + "/static/tonconnect-manifest.json"
});

tonConnectUI.setConnectRequestParameters({ testnet: true });

tonConnectUI.onStatusChange(wallet => {
  if(wallet?.account?.address) saveTonWallet(wallet.account.address);
});

async function saveTonWallet(address){
  await fetch(BACKEND_URL + "/webapp/save_wallet",{
    method:"POST",
    headers:{ "Content-Type":"application/json"},
    body:JSON.stringify({
      initData: tg.initData,
      ton_wallet: address
    })
  });
}

/* ===========================================================
   TON SIMULATED TX
=========================================================== */

async function sendTonDeposit(amount){
  await new Promise(r=>setTimeout(r,1200));
  return "SIMTX-" + Date.now().toString(36);
}

/* ===========================================================
   BACKEND VERIFY / LOAD USER
=========================================================== */

async function verifyInitData(){

  const res = await fetch(BACKEND_URL + "/webapp/me",{
    method:"POST",
    headers:{ "Content-Type":"application/json"},
    body:JSON.stringify({
      initData: tg.initData,
      ref: window.currentRef
    })
  });

  const j = await res.json();

  return j.user;
}

/* ===========================================================
   RENDER REGISTERED VIEW
=========================================================== */

window.renderRegisteredView = async (uid,name,avatar,user)=>{

  window.currentUserData = user;

  document.getElementById("app").innerHTML = `

<div class="deposit-header">
   <button id="menuBtn" class="hamburger">â˜°</button>
   <div class="deposit-title"></div>
</div>

<div class="user-header">
  <img src="${avatar}" class="logo glow" />
  <div class="row big">${name}</div>
  <div class="row mini">Current: <b>${user.role}</b></div>
</div>

<div class="panel">
  <h3>ğŸ’³ Deposit</h3>

  <label>Amount (USD)</label>
  <input id="amt" type="number" min="20" step="0.01" placeholder="Minimum $20">

  <div class="submit">
    <button id="submitDeposit" class="btn secondary">Submit Deposit</button>
  </div>

  <div id="submitMsg" class="ok" style="display:none;"></div>
</div>

  `;

document.getElementById("menuBtn").onclick = openMenu;
document.getElementById("submitDeposit").onclick = handleDeposit;

setTimeout(updateAdminMenuVisibility,40);

};

/* ===========================================================
   DEPOSIT PROCESSING
=========================================================== */

async function handleDeposit(){

  const amount = parseFloat(document.getElementById("amt").value);
  const msgEl = document.getElementById("submitMsg");
  
  if(isNaN(amount) || amount < 20){
    msgEl.style.display="block";
    msgEl.textContent="Minimum $20 required";
    return;
  }

  msgEl.style.display = "block";
  msgEl.textContent = "Processing...";

  const tx = await sendTonDeposit(amount);

  const res = await fetch(BACKEND_URL + "/deposit/submit",{
    method:"POST",
    headers:{ "Content-Type":"application/json"},
    body:JSON.stringify({
      user_id: window.currentUserData.id,
      amount: amount,
      tx_musd: tx,
      ref: window.currentRef
    })
  });

  const j = await res.json();

  if(!j.ok){
    msgEl.textContent = j.error;
    return;
  }

  msgEl.textContent = "Deposit successful!";
  await showRegisteredViewFromBackend();
}

/* ===========================================================
   MENU CONTROLS - SINGLE PLACE ONLY
=========================================================== */

function openMenu(){
  document.getElementById("sideMenu").classList.add("open");
  document.getElementById("menuOverlay").classList.add("show");
}

function closeMenu(){
  document.getElementById("sideMenu").classList.remove("open");
  document.getElementById("menuOverlay").classList.remove("show");
}

document.getElementById("closeMenu").addEventListener("click", closeMenu);
document.getElementById("menuOverlay").addEventListener("click", closeMenu);

/* ===========================================================
   ADMIN MENU CONTROL
=========================================================== */

function updateAdminMenuVisibility(){
  
  const role = window.currentUserData?.role;
  const menu = document.getElementById("adminMenu");

  if(role === "admin" || role === "superadmin"){
    menu.style.display = "block";
  } else {
    menu.style.display = "none";
  }
}

/* ===========================================================
   MAIN LOAD ENTRY
=========================================================== */

async function showRegisteredViewFromBackend(){

  const u = await verifyInitData();

  const name = u.first_name;
  const avatar = u.photo_url || "./Botologo_new.png";

  renderRegisteredView(u.id,name,avatar,u);
}

showRegisteredViewFromBackend();

</script>

</body>
</html>
